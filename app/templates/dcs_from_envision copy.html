{% extends "base.html" %}
{% block content %}
<div class="container py-3">
  <h2 class="mb-1">DCS &rarr; Flight Plan — {{ day.isoformat() }}</h2>
  <div class="text-muted mb-1">
    <small>All times shown below are NZ local (Pacific/Auckland).</small>
  </div>
  <div class="text-muted mb-3">
    <small>
      Click a flight bar to view details and <strong>Send to Flight Plan</strong>.
    </small>
  </div>
<div class="text-muted small">
  Last refreshed: <span id="gantt-last-refresh">never</span>
</div>
  <form class="row g-2 mb-3" method="get">
    <div class="col-auto">
      <label class="form-label">Date</label>
      <input type="date" name="date" class="form-control" value="{{ day.isoformat() }}">
    </div>
    <div class="col-auto align-self-end">
      <button class="btn btn-primary">Load</button>
    </div>
  </form>

<!-- NEW: base filter -->
<div class="row g-2 mb-3">
  <div class="col-auto ms-auto">
    <label for="base-filter" class="form-label mb-1">Base filter</label>
    <select id="base-filter" class="form-select form-select-sm">
      <option value="">All bases</option>
      <option value="AKL">AKL (Auckland)</option>
      <option value="WLG">WLG (Wellington)</option>
      <option value="CHC">CHC (Christchurch)</option>
      <option value="PPQ">PPQ (Paraparaumu)</option>
      <option value="WHK">WHK (Whakatane)</option>
      <option value="WAG">WAG (Whanganui)</option>
      <option value="CHT">CHT (Chatham Islands)</option>
      <option value="ZQN">ZQN (Queenstown)</option>
      <option value="BHE">BHE (Blenheim)</option>
    </select>
  </div>
</div>

  {# ---------- Hidden data for JS to build the Gantt ---------- #}
  <div id="dcs-gantt-data" class="d-none">
    {% for r in results %}
  <div
    class="gantt-flight-data"
    data-reg="{{ r.reg or 'Unknown' }}"
    data-dep="{{ r.dep }}"
    data-ades="{{ r.ades }}"
    data-std="{{ r.std_nz.isoformat() if r.std_nz }}"
    data-sta="{{ r.sta_nz.isoformat() if r.sta_nz }}"
    data-std-sched="{{ r.std_sched_nz.isoformat() if r.std_sched_nz }}"
    data-sta-sched="{{ r.sta_sched_nz.isoformat() if r.sta_sched_nz }}"
    data-dep-actual="{{ r.dep_actual_nz.isoformat() if r.dep_actual_nz }}"
    data-arr-actual="{{ r.arr_actual_nz.isoformat() if r.arr_actual_nz }}"
    data-flight="{{ r.flight_number }}"
    data-designator="{{ r.designator }}"
    data-apg-plan-id="{{ r.apg_plan_id or '' }}"
    data-block="{{ r.block_mins }}"
    data-aircraft-type="{{ r.aircraft_type }}"
    data-flight-status="{{ r.flight_status }}"
    data-adt="{{ r.adt|default(0) }}"
    data-chd="{{ r.chd|default(0) }}"
    data-inf="{{ r.inf|default(0) }}"
    data-pax-count="{{ r.pax_count|default(0) }}"
    data-bags-kg="{{ '%.1f'|format((r.bags_kg or 0)|float) }}"
    data-pax-list='{{ (r.pax_list or [])|tojson|e }}'
    data-envision-flight-id="{{ r.envision_flight_id or '' }}"
    data-delays='{{ (r.delays or [])|tojson|e }}'
  ></div>

    {% endfor %}
  </div>


  {# ---------- Visible Gantt shell ---------- #}
  <div class="dcs-gantt-shell card shadow-sm position-relative">
    <!-- Centered loading overlay -->
    <div id="gantt-loading" class="gantt-loading-overlay">
      <div class="gantt-loading-pill">
        <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
        Loading data…
      </div>
    </div>

    <div class="card-body p-2">
      <div class="dcs-gantt-header d-flex align-items-center mb-1">
        <div class="gantt-label-col text-muted fw-semibold">
          Aircraft
        </div>
        <div class="gantt-time-col flex-grow-1 ps-2">
          <div id="dcs-gantt-axis" class="dcs-gantt-axis"></div>
        </div>
      </div>
      <div id="dcs-gantt-rows" class="dcs-gantt-rows"></div>
    </div>
  </div>


  {# ---------- Diagnostics ---------- #}
  {% if diag %}
  <div class="alert alert-info mt-3">
    <div><strong>Diagnostics</strong></div>
    <div>Window used: {{ diag.window_used or 'N/A' }} <span class="text-muted">(UTC query window)</span></div>
    <div>Envision base: {{ diag.base or 'N/A' }}</div>
    <div>Token present: {{ 'Yes' if diag.has_token else 'No' }}</div>
    <div>Raw type: {{ diag.raw_type or 'N/A' }}</div>

    {% if diag.note %}
    <div class="mt-2 text-muted">{{ diag.note }}</div>
    {% endif %}

    {% if diag.raw_preview %}
    <details class="mt-2">
      <summary>JSON preview (first page or first 2 items)</summary>
      <pre class="small mb-0" style="white-space: pre-wrap">{{ diag.raw_preview }}</pre>
    </details>
    {% endif %}

    <details class="mt-3" id="apg-plan-details" style="display:none;">
      <summary>APG plan/get JSON (last pushed plan)</summary>
      <div class="small text-muted mb-1">
        Plan ID: <span id="apg-plan-id"></span>
      </div>
      <pre class="small mb-0" style="white-space: pre-wrap" id="apg-plan-json"></pre>
    </details>

    {% if diag.raw_http %}
    <details class="mt-3">
      <summary>Raw HTTP (first page)</summary>
      <div class="small">
        <div><strong>URL:</strong> {{ diag.raw_http.url }}</div>
        <div><strong>Params:</strong> {{ diag.raw_http.params }}</div>
        <div><strong>Status:</strong> {{ diag.raw_http.status }}</div>
        <div><strong>Content-Type:</strong> {{ diag.raw_http.content_type }}</div>
        {% if diag.raw_http.json_preview %}
        <details class="mt-2">
          <summary>JSON (parsed)</summary>
          <pre class="small mb-0" style="white-space: pre-wrap">{{ diag.raw_http.json_preview }}</pre>
        </details>
        {% endif %}
        {% if diag.raw_http.raw_text %}
        <details class="mt-2">
          <summary>Body (raw text)</summary>
          <pre class="small mb-0" style="white-space: pre-wrap">{{ diag.raw_http.raw_text }}</pre>
        </details>
        {% endif %}
      </div>
    </details>
    {% endif %}
  </div>
  {% endif %}
</div>

<!-- Gantt Loading -->
<table class="table">
  <tbody id="dcs-gantt-body"></tbody>
</table>


<!-- Flight Action Modal -->
<div class="modal fade" id="flightActionModal" tabindex="-1" aria-labelledby="flightActionModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-xl modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <div class="me-3">
          <h5 class="modal-title mb-0" id="flightActionModalLabel">Flight Details</h5>
          <!-- Warnings under the title -->
          <div id="flight-warnings" class="small mt-1"></div>
        </div>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>

      <div class="modal-body">
        <!-- 4-quarter layout -->
        <div class="flight-details-grid">

          <!-- Q1: Flight / Route / Aircraft -->
          <div class="detail-card">
            <h6 class="detail-title">Flight</h6>
            <p class="mb-1 fw-semibold">
              <span id="modal-flight-code"></span>
            </p>
            <p class="mb-1 small text-muted">
              Route:
              <span id="modal-route"></span>
            </p>
            <p class="mb-0 small text-muted">
              Aircraft:
              <span id="modal-aircraft"></span>
            </p>
          </div>

          <!-- Q2: Times / Status -->
          <div class="detail-card detail-card-times">
            <h6 class="detail-title">Times</h6>

            <div class="time-row">
              <span class="time-label">STD / STA</span>
              <span class="time-value" id="modal-std-sta"></span>
            </div>
            <div class="time-row">
              <span class="time-label">ETD / ETA</span>
              <span class="time-value" id="modal-etd-eta"></span>
            </div>
            <div class="time-row">
              <span class="time-label">ATD / ATA</span>
              <span class="time-value" id="modal-atd-ata">— / —</span>
            </div>
            <div class="time-row mt-1">
              <span class="time-label">Status</span>
              <span class="time-value" id="modal-status"></span>
            </div>
          </div>

          <!-- Q3: Delays -->
          <div class="detail-card detail-card-delays">
            <h6 class="detail-title">Delays</h6>
            <div id="modal-delays" class="small text-muted">
              <!-- filled by JS -->
            </div>
          </div>

          <!-- Q4: Passengers & Baggage -->
          <div class="detail-card detail-card-pax">
            <h6 class="detail-title">Passengers</h6>

            <!-- Heading then status underneath -->
            <div id="modal-pax-breakdown" class="pax-breakdown small mb-2">
              <!-- filled by JS -->
            </div>

            <div class="small text-muted" id="modal-pax-types">
              <!-- e.g. "Total: 120 (AD 100 / CHD 15 / INF 5)" -->
            </div>

            <hr class="my-2">

            <h6 class="detail-title mb-1">Baggage</h6>
            <p class="mb-0 small">
              <span id="modal-bags"></span> kg
            </p>
          </div>

        </div>

        <hr class="my-3">

        <div class="d-flex flex-wrap gap-2">
          <button id="btn-view-pax" type="button" class="btn btn-outline-secondary btn-sm">
            Passenger list
          </button>
          <button id="btn-seatmap" type="button" class="btn btn-outline-secondary btn-sm">
            Seat map
          </button>
        </div>
      </div>

      <div class="modal-footer">
        <button id="btn-reset-apg" type="button" class="btn btn-success">Reset Flight</button>
        <button id="btn-send-apg" type="button" class="btn btn-success">Submit to APG</button>
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<!-- Passenger List Modal -->
<div class="modal fade" id="paxListModal" tabindex="-1"
     aria-labelledby="paxListModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="paxListModalLabel">Passenger list</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"
                aria-label="Close"></button>
      </div>

    <div class="modal-body">
      <div class="table-responsive mb-0">
        <table id="pax-list-table" class="table table-sm align-middle mb-0">
          <thead>
            <tr>
              <th>Seat</th>
              <th>Name</th>
              <th>DOB</th>
              <th>Age</th>
              <th>PNR</th>
              <th>Status</th>
              <th>SSR(s)</th>
            </tr>
          </thead>
          <tbody id="pax-list-body">
            <!-- filled by JS -->
          </tbody>
        </table>
      </div>
    </div>


      <div class="modal-footer">
        <button type="button" class="btn btn-secondary btn-sm"
                data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>


<!-- Seatmap Modal -->
<div class="modal fade" id="seatmapModal" tabindex="-1" aria-labelledby="seatmapModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="seatmapModalLabel">Seat map</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="row">
          <div class="col-md-8">
            <div id="seatmap-container" class="seatmap-grid"></div>
          </div>
          <div class="col-md-4">
            <div id="seatmap-info" class="small text-muted">
              Seatmap not available for this aircraft type.<br>
              Click a seat to see passenger details.
            </div>
          </div>
        </div>

        <!-- NEW: legend / key for colours + icons -->
        <div id="seatmap-legend" class="small mt-2">
          <span class="legend-item">
            <span class="seat seat-adult"></span> Adult
          </span>
          <span class="legend-item">
            <span class="seat seat-child"></span> Child
          </span>
          <span class="legend-item">
          <span class="seat seat-child seat-umnr"></span> UMNR
          </span>

          <span class="legend-item">
            <span class="seat seat-infant"></span> Infant in Lap
          </span>
          <span class="legend-item">
            <span class="seat-icon seat-icon-special">!</span> Special SSR
          </span>
          <span class="legend-item">
            <span class="seat-icon seat-icon-wheelchair">♿</span> Wheelchair SSR
          </span>
        </div>
      </div>
      <div class="modal-footer">
        <small class="text-muted me-auto">Layout is indicative only.</small>
        <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<!-- Times / Delay Modal -->
<div class="modal fade" id="timeModal" tabindex="-1" aria-labelledby="timeModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="timeModalLabel">Times</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">

        <!-- Existing core times content (built by JS) -->
        <div id="time-modal-core"></div>

        <div id="delay-section" class="mt-3 pt-2 border-top d-none">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <strong>Delay Codes</strong>
            <button id="btn-add-delay" type="button" class="btn btn-outline-secondary btn-sm">Add code</button>
          </div>
          <div class="table-responsive">
            <table class="table table-sm mb-2">
              <thead>
                <tr>
                  <th>Code</th>
                  <th class="text-end">Minutes</th>
                  <th>Reason</th>
                  <th>Remark</th>  
                  <th></th>
                </tr>
              </thead>
              <tbody id="delay-rows"></tbody>
            </table>
          </div>
          <div class="small">
            Required delay: <span id="delay-required">0</span> min<br>
            Allocated: <span id="delay-allocated">0</span> min
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <small class="text-muted me-auto">
          Times are local and not yet persisted.
        </small>
        <button type="button" class="btn btn-primary btn-sm" id="btn-save-times">
          Save times
        </button>
        <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">
          Close
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Right-click context menu -->
<div id="flightContextMenu" class="dropdown-menu" style="position:absolute; display:none; z-index:1060;">
  <button class="dropdown-item" type="button" id="ctx-departure">Departure Times</button>
  <button class="dropdown-item" type="button" id="ctx-arrival">Arrival Times</button>
</div>


<style>
.dcs-gantt-shell {
  margin-top: 0.75rem;
  position: relative; /* ensure overlay is positioned relative to the card */
}

/* Centered loading overlay */
.gantt-loading-overlay {
  position: absolute;
  inset: 0;
  display: flex;
  align-items: center;
  justify-content: center;
  pointer-events: none;      /* don’t block clicks once hidden */
  z-index: 20;
}

.gantt-loading-pill {
  pointer-events: auto;      /* allow tooltip etc if you ever want */
  background: rgba(255, 255, 255, 0.95);
  border-radius: 999px;
  padding: 0.35rem 0.9rem;
  font-size: 0.85rem;
  color: #495057;
  box-shadow: 0 4px 12px rgba(15, 23, 42, 0.18);
  border: 1px solid rgba(148, 163, 184, 0.6);
  display: inline-flex;
  align-items: center;
}

.gantt-loading-inner {
  display: inline-flex;
  align-items: center;
  padding: 0.4rem 0.75rem;
  border-radius: 999px;
  background: rgba(255, 255, 255, 0.85);
  box-shadow: 0 2px 6px rgba(15, 23, 42, 0.2);
  font-size: 0.85rem;
  color: #6c757d;
}

.dcs-gantt-header .gantt-label-col {
  width: 120px;
  flex-shrink: 0;
}
.dcs-gantt-axis {
  position: relative;
  height: 30px;
  border-bottom: 1px solid #e5e7eb;
  font-size: 0.75rem;
}
.dcs-gantt-axis .tick {
  position: absolute;
  top: 0;
  bottom: 0;
  border-left: 1px dashed #e5e7eb;
  padding-left: 2px;
  transform: translateX(-50%);
  color: #6c757d;
  white-space: nowrap;
}
.dcs-gantt-axis .tick-label {
  position: absolute;
  bottom: 0;
  transform: translate(-50%, 0);
}
.dcs-gantt-rows {
  max-height: 600px;
  overflow-y: auto;
  border-radius: 0 0 .25rem .25rem;
}

.gantt-row-label {
  width: 120px;
  flex-shrink: 0;
  padding: 0.35rem 0.5rem;
  font-weight: 600;
  font-size: 0.85rem;
  background: #f8fafc;
  border-right: 1px solid #e5e7eb;
}
.gantt-row-track {
  position: relative;
  flex-grow: 1;
  background: #fbfdff;
}

/* main flight bar (ETD/ETA) */
.gantt-flight {
  position: absolute;
  top: 18px;
  height: 20px;
  font-size: 0.8rem;
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 0 10px;
  overflow: hidden;
  white-space: nowrap;
  text-overflow: ellipsis;
  cursor: pointer;
  box-shadow: 0 1px 3px rgba(15, 23, 42, 0.15);
  border-radius: 0;
  color: #fff;
}

/* give the row a bit more height to play with */
.gantt-row {
  display: flex;
  border-bottom: 1px solid #f1f3f5;
  min-height: 60px;          /* was 44px */
}

/* scheduled bar lower down */
.gantt-flight-sched {
  position: absolute;
  top: 11px;
  height: 6px;               /* slightly slimmer, optional */
  background: #4c1d95;
  border-radius: 0;
}

/* main “puck” further below the scheduled bar */
.gantt-flight {
  position: absolute;
  top: 17px;                 /* was 18px */
  height: 20px;
  /* rest as before… */
}

/* airport labels clearly above the scheduled bar */
.gantt-airport-label {
  position: absolute;
  top: -4px;                  /* was 0px → moves them further up */
  font-size: 0.7rem;
  color: #6c757d;
  pointer-events: none;
}

.gantt-airport-label.dep {
  transform: translateX(-100%);  /* move whole label left of bar start */
  text-align: right;             /* keeps text snug against the bar */
}

.gantt-airport-label.arr {
  transform: translateX(0);      /* anchor label’s left edge on bar end */
  margin-left: 4px;              /* small gap to the right of the bar */
}


#timeModal .modal-dialog {
  max-width: 800px;
}

/* status colours (from your screenshot) */
.gantt-flight.status-planning      { background-color: #00ff00; color:#000; }
.gantt-flight.status-onblocks      { background-color: #000000; }
.gantt-flight.status-offblocks     { background-color: #e37373; }
.gantt-flight.status-takeoff       { background-color: #0080ff; }
.gantt-flight.status-landed        { background-color: #00fff1; color:#000; }
.gantt-flight.status-diverted      { background-color: #ffab00; color:#000; }
.gantt-flight.status-returntostand { background-color: #ff9800; color:#000; }
.gantt-flight.status-unknown       { background-color: #6c757d; }

.gantt-flight.sent {
  box-shadow: 0 0 0 2px #198754;
}

/* === Seat map === */
.seatmap-grid {
  display: grid;
  grid-auto-rows: 32px;
  grid-gap: 4px;
  justify-content: flex-start;
  padding: 4px 0;
}

/* we’ll set column count dynamically in JS */
.seatmap-row-label {
  font-size: 0.75rem;
  display: flex;
  align-items: center;
  justify-content: flex-end;
  padding-right: 4px;
  font-weight: 600;
}

.seat {
  width: 28px;
  height: 28px;
  border-radius: 4px;
  background: #9ca3af; /* empty/default */
  display: inline-flex;      /* was: flex */
  align-items: center;
  justify-content: center;
  font-size: 0.65rem;
  color: #fff;
  position: relative;
  cursor: pointer;
}

/* seat colours by pax type / SSR */
.seat-adult {
  background: #eab308; /* nice yellow */
}
.seat-child {
  background: #22c55e; /* nice green */
}
/* adult with lap infant SSR (INFT/INF) */
.seat-adult-infant {
  background: #0ea5e9; /* blue */
}
/* optional: dedicated infant seat if you ever get one */
.seat-infant {
  background: #0ea5e9;
}
/* explicit empty seat class (uses default grey) */
.seat-empty {
  background: #9ca3af;
}
/* icons overlay */
.seat-icons {
  position: absolute;
  bottom: 1px;
  right: 2px;
  display: flex;
  gap: 1px;
}

.seat-icon {
  font-size: 0.55rem;
  line-height: 1;
}

.seat-icon-special {
  color: #000000; /* yellow */
}

.seat-icon-wheelchair {
  color: #38bdf8;
}

/* UMNR highlight: child + red border */
.seat-umnr {
  border: 2px solid #dc2626;   /* red */
  box-shadow: 0 0 4px rgba(220, 38, 38, 0.7);
}

.seat-icon-umnr {
  font-size: 0.7rem;
}

/* highlight on hover */
.seat:hover {
  outline: 2px solid #f97316;
}

/* legend icons (re-use styles but without seat box) */
#seatmap-legend .seat {
  cursor: default;
}
/* === Large seat map modal layout (2+1 / 2+2) === */
.seatmap-layout {
  display: flex;
  flex-direction: column;
  gap: 4px;
  padding: 4px 0;
}

/* One row of seats (e.g. "1 A _ BC") */
.seat-row {
  display: flex;
  align-items: center;
  gap: 8px;
}

/* Row number on the left */
.seat-label {
  width: 24px;
  text-align: right;
  font-size: 0.75rem;
  font-weight: 600;
}

/* Block of seats (left or right of aisle) */
.seat-block {
  display: flex;
  gap: 4px;
}

/* Visual aisle gap between left/right blocks */
.seat-aisle {
  width: 18px;
}

/* legend layout */
#seatmap-legend {
  display: flex;
  align-items: center;
  flex-wrap: wrap;
  gap: 0.75rem 1.5rem;
}

#seatmap-legend .legend-item {
  display: inline-flex;
  align-items: center;
}

#seatmap-legend .seat {
  cursor: default;           /* keep it non-clickable in legend */
  margin-right: 0.35rem;
}
#flight-warnings .badge {
  margin-left: 0.25rem;
}
/* 2×2 grid for the details */
.flight-details-grid {
  display: grid;
  grid-template-columns: 1fr;
  gap: 0.75rem;
}

@media (min-width: 768px) {
  .flight-details-grid {
    grid-template-columns: repeat(2, minmax(0, 1fr));
  }
}

/* The “quarter” cards */
.detail-card {
  background-color: var(--bs-gray-100);
  border-radius: 0.75rem;
  padding: 0.75rem 1rem;
  border: 1px solid rgba(0, 0, 0, 0.03);
}

/* Small uppercase section titles */
.detail-title {
  font-size: 0.75rem;
  text-transform: uppercase;
  letter-spacing: 0.06em;
  color: var(--bs-gray-600);
  margin-bottom: 0.35rem;
}

/* 2×2 grid for the details */
.flight-details-grid {
  display: grid;
  grid-template-columns: 1fr;
  gap: 0.75rem;
}

@media (min-width: 768px) {
  .flight-details-grid {
    grid-template-columns: repeat(2, minmax(0, 1fr));
  }
}

/* Quarter cards */
.detail-card {
  background-color: #f9fafb;
  border-radius: 0.75rem;
  padding: 0.85rem 1rem;
  border: 1px solid rgba(15, 23, 42, 0.04);
}

/* Small uppercase section titles */
.detail-title {
  font-size: 0.75rem;
  text-transform: uppercase;
  letter-spacing: 0.06em;
  color: var(--bs-gray-600);
  margin-bottom: 0.35rem;
}

/* Times block layout */
.detail-card-times .time-row {
  display: flex;
  justify-content: space-between;
  align-items: baseline;
  font-size: 0.8rem;
  margin-bottom: 0.15rem;
}

.detail-card-times .time-label {
  color: var(--bs-gray-600);
}

.detail-card-times .time-value {
  font-weight: 500;
}

/* Delays table stays inside Q3 */
.detail-card-delays #modal-delays {
  max-height: 130px;
  overflow-y: auto;
}

.detail-card-delays table {
  font-size: 0.75rem;
  margin-bottom: 0;
}

/* Passenger breakdown stacked lines */
.pax-breakdown .pax-line {
  display: flex;
  justify-content: space-between;
  margin-bottom: 0.1rem;
}

.pax-breakdown .pax-label {
  color: var(--bs-gray-600);
}

.pax-breakdown .pax-value {
  font-weight: 600;
}


</style>

<script>
document.addEventListener("DOMContentLoaded", function () {
  const dataNodes     = Array.from(document.querySelectorAll(".gantt-flight-data"));
  const rowsContainer = document.getElementById("dcs-gantt-rows");
  const axisEl        = document.getElementById("dcs-gantt-axis");
  const spinner       = document.getElementById("gantt-loading");

  if (!rowsContainer || !axisEl) return;
  
  const loadingEl = document.getElementById("gantt-loading");

  function setGanttLoading(isLoading) {
    if (!loadingEl) return;
    loadingEl.style.display = isLoading ? "flex" : "none";
  }


  const DEFAULT_BLOCK_MIN = 60;

  // Base → ICAO mapping
  const BASE_ICAO = {
    "AKL": "NZAA",  // Auckland
    "WLG": "NZWN",  // Wellington
    "CHC": "NZCH",  // Christchurch
    "PPQ": "NZPP",  // Paraparaumu
    "WHK": "NZWK",  // Whakatane
    "WAG": "NZWU",  // Whanganui
    "CHT": "NZCI",  // Chatham Islands
    "ZQN": "NZQN",  // Queenstown
    "BHE": "NZWB",  // Blenheim
  };

    // ---------- Delay code metadata (IATA code -> Envision ID + description) ----------
  const DELAY_CODE_META = {
    "81": { id: 7,   description: "ATFM due to ATC en-route demand capacity" },
    "11": { id: 9,   description: "Late check-in, acceptance after deadline" },
    "12": { id: 10,  description: "Late check-in, congestion in check-in" },
    "15": { id: 14,  description: "Boarding, discrepancies and paging, missing check-in passenger" },
    "16": { id: 16,  description: "Commercial publicity/passenger convenience, illness/death, VIP, Press, TV" },
    "17": { id: 17,  description: "Catering order, late or incorrect order given to supplier" },
    "18": { id: 18,  description: "Baggage Processing, sorting etc" },
    "21": { id: 19,  description: "Cargo documentation, errors" },
    "22": { id: 20,  description: "Late positioning of Cargo" },
    "23": { id: 21,  description: "Late acceptance of Cargo" },
    "24": { id: 22,  description: "Inadequate cargo packing and/or quantity" },
    "25": { id: 23,  description: "Oversells, cargo booking error" },
    "26": { id: 24,  description: "Late cargo preparation in warehouse" },
    "27": { id: 25,  description: "Mail documentation, errors" },
    "28": { id: 26,  description: "Late mail positioning" },
    "31": { id: 27,  description: "Aircraft documentation late/inaccurate (W&B, gen dec, pax manifest, etc.)" },
    "32": { id: 28,  description: "Loading / Unloading, bulky/special load, lack of loading staff" },
    "33": { id: 29,  description: "Loading equipment, lack of/or breakdown" },
    "34": { id: 30,  description: "Servicing equipment, lack of/or breakdown, lack of staff (e.g. steps)" },
    "35": { id: 31,  description: "Aircraft cleaning" },
    "36": { id: 32,  description: "Fuelling / defueling" },
    "37": { id: 33,  description: "Catering, late delivery or loading" },
    "38": { id: 34,  description: "ULD, lack of or serviceability" },
    "39": { id: 35,  description: "Technical equipment lack or breakdown" },
    "41": { id: 36,  description: "Aircraft defects" },
    "42": { id: 37,  description: "Scheduled maintenance, late release" },
    "43": { id: 38,  description: "Non scheduled maintenance, extra checks / additional work" },
    "44": { id: 39,  description: "Spares and maintenance equipment, lack of/or breakdown" },
    "45": { id: 40,  description: "AOG spares, to be carried to another station" },
    "46": { id: 41,  description: "Aircraft change for technical reasons within same fleet" },
    "47": { id: 44,  description: "Stand-by aircraft, lack of planned stand-by aircraft for technical reasons" },
    "51": { id: 45,  description: "Damage in flight ops (bird/lighting/turbulence/overweight landing/taxi collision)" },
    "52": { id: 46,  description: "Damage during ground operations, collision (other than during taxi)" },
    "55": { id: 48,  description: "Departure Control" },
    "56": { id: 49,  description: "Cargo preparation / documentation" },
    "57": { id: 50,  description: "Flight Plans" },
    "58": { id: 51,  description: "Other automated systems" },
    "61": { id: 52,  description: "Flight Plan, late completion / change, flight documentation" },
    "62": { id: 53,  description: "Operational requirements, fuel / load alteration" },
    "63": { id: 56,  description: "Late crew boarding / departure procedures (other than connection/stand-by)" },
    "71": { id: 62,  description: "Departure station below aircraft operating limits" },
    "72": { id: 63,  description: "Destination station below aircraft operating limits" },
    "73": { id: 64,  description: "Alternate station below aircraft operating limits" },
    "74": { id: 65,  description: "Enroute – strong headwind, rerouting, weather avoidance" },
    "75": { id: 66,  description: "De-icing and de-snowing of aircraft" },
    "76": { id: 67,  description: "Removal of snow, ice, water and sand from airport" },
    "77": { id: 68,  description: "Ground handling impacted by adverse weather conditions" },
    "85": { id: 88,  description: "Restrictions at departure airport (closure, unrest, noise abatement, etc.)" },
    "86": { id: 89,  description: "Immigration, customs, health" },
    "87": { id: 90,  description: "Airport facilities, stands, ramp congestion, lighting, buildings, gate limits" },
    "88": { id: 91,  description: "Restrictions at destination airport, with or without ATFM" },
    "93": { id: 92,  description: "Aircraft rotation, late arrival from previous sector" },
    "99": { id: 93,  description: "Other reason, not matching any codes above" },
    "01": { id: 94,  description: "Planned schedule deviation for regular flights" },
    "02": { id: 95,  description: "Planned schedule deviation for charter flights" },
    "03": { id: 96,  description: "Late bus" },
    "13": { id: 98,  description: "Check-in error passenger and/or baggage" },
    "14": { id: 99,  description: "Oversales booking error" },
    "29": { id: 101, description: "Late mail acceptance" },
    "48": { id: 102, description: "Scheduled cabin configuration/version adjustments" },
    "59": { id: 103, description: "Operational requirements; fuel or load alteration" },
    "60": { id: 104, description: "Late crew boarding or departure procedures" },
    "64": { id: 105, description: "Flight deck crew shortage/sickness/stand-by/FTL" },
    "65": { id: 106, description: "Flight deck crew special request (non-operational)" },
    "66": { id: 107, description: "Late cabin crew boarding/departure (not connections/stand-by)" },
    "82": { id: 108, description: "ATFM due to ATC staff/equipment en-route, industrial action, staff shortage" },
    "83": { id: 109, description: "ATFM due to restriction at destination airport" },
    "84": { id: 110, description: "ATFM due to weather at destination" },
    "89": { id: 111, description: "Restrictions at departure airport inc. ATS/start-up/pushback" },
    "91": { id: 112, description: "Load connection, awaiting from another flight" },
    "92": { id: 113, description: "Through check-in error passenger and baggage" },
    "94": { id: 114, description: "Cabin crew rotation awaiting cabin crew from another flight" },
    "95": { id: 115, description: "Crew rotation awaiting crew from another flight" },
    "96": { id: 116, description: "Ops control re-routing, diversion, a/c change (non-technical)" },
    "97": { id: 117, description: "Industrial action within own airline" },
    "98": { id: 118, description: "Industrial action outside own airline, excluding ATC" },
    "67": { id: 119, description: "Cabin crew shortage/sickness/stand-by/FTL" }
  };

  // ---------- Helpers ----------
  function parseDate(val) {
    if (!val) return null;
    const d = new Date(val);
    return isNaN(d.getTime()) ? null : d;
  }

function hasUmnrSSR(ssrs) {
  if (!Array.isArray(ssrs)) return false;
  return ssrs.some(s => {
    const code = (s.Code || s.code || "").toUpperCase();
    return code === "UMNR" || code === "UM"; // cover both if they ever use UM
  });
}


  function formatDateYMD(d) {
    if (!d) return "";
    const yyyy = d.getFullYear();
    const mm   = String(d.getMonth() + 1).padStart(2, "0");
    const dd   = String(d.getDate()).padStart(2, "0");
    return `${yyyy}-${mm}-${dd}`;
  }

  function fmtTime(d) {
    if (!d) return "";
    return d.toLocaleTimeString("en-NZ", {
      hour: "2-digit",
      minute: "2-digit",
      hour12: false,
    });
  }

  function normaliseStatus(status) {
    if (!status) return "unknown";
    const s = status.toLowerCase();
    if (s.includes("planning"))        return "planning";
    if (s.includes("on blocks"))       return "onblocks";
    if (s.includes("off blocks"))      return "offblocks";
    if (s.includes("take off"))        return "takeoff";
    if (s.includes("landed"))          return "landed";
    if (s.includes("return to stand")) return "returntostand";
    if (s.includes("divert"))          return "diverted";
    return "unknown";
  }

    // ---------- Build rows from DOM (hidden .gantt-flight-data divs) ----------
  function buildRowsFromDom(nodes) {
    return nodes.map(node => ({
      reg: node.dataset.reg || "Unknown",
      dep: node.dataset.dep || "",
      ades: node.dataset.ades || "",
      std_nz: node.dataset.std || null,
      sta_nz: node.dataset.sta || null,
      std_sched_nz: node.dataset.stdSched || null,
      sta_sched_nz: node.dataset.staSched || null,
      dep_actual_nz: node.dataset.depActual || null,
      arr_actual_nz: node.dataset.arrActual || null,
      flight_number: node.dataset.flight || "",
      designator: node.dataset.designator || "",
      apg_plan_id: node.dataset.apgPlanId || "",
      block_mins: node.dataset.block || "0",
      aircraft_type: node.dataset.aircraftType || "",
      flight_status: node.dataset.flightStatus || "",
      adt: node.dataset.adt || "0",
      chd: node.dataset.chd || "0",
      inf: node.dataset.inf || "0",
      pax_count: node.dataset.paxCount || "0",
      bags_kg: node.dataset.bagsKg || "0",
      pax_list: node.dataset.paxList ? JSON.parse(node.dataset.paxList) : [],
      envision_flight_id: node.dataset.envisionFlightId || null,      // NEW
      delays: node.dataset.delays ? JSON.parse(node.dataset.delays) : [],

    }));
  }
  // ---------- Convert rows → flights model ----------
function buildFlightsFromRows(rows) {
  return rows
    .map((row, idx) => {
      const stdEst    = parseDate(row.std_nz);
      const staEst    = parseDate(row.sta_nz);
      const stdSched  = parseDate(row.std_sched_nz);
      const staSched  = parseDate(row.sta_sched_nz);

      // NEW: actuals
      const depActual = parseDate(row.dep_actual_nz);
      const arrActual = parseDate(row.arr_actual_nz);

      const block = parseInt(row.block_mins || "0", 10) || DEFAULT_BLOCK_MIN;

      // Primary times used for the bar:
      // 1) Actual if present
      // 2) Otherwise estimated
      // 3) Otherwise scheduled
      let barStart = depActual || stdEst || stdSched || null;
      let barEnd   = arrActual || staEst || staSched || null;

      if (!barEnd && barStart) {
        barEnd = new Date(barStart.getTime() + block * 60000);
      }

      const flightFull = (row.flight_number || "").trim();
      const designator = (row.designator || "").trim().toUpperCase();

      let numericPart = flightFull;
      if (designator && flightFull.toUpperCase().startsWith(designator)) {
        numericPart = flightFull.slice(designator.length);
      }

      let paxList = [];
      try {
        paxList = row.pax_list || [];
      } catch (e) {
        console.warn("Bad pax_list JSON", e);
      }

      return {
        id: idx,
        reg: (row.reg || "UNKNOWN").toUpperCase().trim(),
        dep: (row.dep || "").toUpperCase(),
        ades: (row.ades || "").toUpperCase(),

        // These now represent the times used to draw the bar:
        stdEst: barStart,
        staEst: barEnd,

        // Keep scheduled too for the thin bar / labels
        stdSched,
        staSched,

        // Optional: keep raw actuals if you want them later in tooltips
        depActual,
        arrActual,

        designator,
        flightFull,
        flightNumeric: numericPart,
        apgPlanId: row.apg_plan_id || "",
        blockMins: block,
        statusRaw: row.flight_status || "",
        statusNorm: normaliseStatus(row.flight_status),
        paxTotal: parseInt(row.pax_count || "0", 10) || 0,
        paxAdt: parseInt(row.adt || "0", 10) || 0,
        paxChd: parseInt(row.chd || "0", 10) || 0,
        paxInf: parseInt(row.inf || "0", 10) || 0,
        bagsKg: parseFloat(row.bags_kg || "0") || 0,
        paxList,
        aircraftType: row.aircraft_type || "",
        envisionFlightId: row.envision_flight_id || null,
        delays: row.delays || [],
      };
    })
    .filter(f => f.stdEst && f.staEst);  // now these are barStart/barEnd
}


  // ---------- Global Gantt state ----------
  let flights    = [];
  let chartStart = null;
  let chartEnd   = null;
  let durationMs = 0;
  let byReg      = {};
  let regs       = [];
  let firstRefresh = true;  // controls the loading overlay (only on first fetch)

  // ---------- Modals / context menu shared state ----------
  let currentFlight = null;
  let currentBarEl  = null;
  let currentTimeMode = null;  // "dep" or "arr"

  const actionModalEl  = document.getElementById("flightActionModal");
  const actionModal    = actionModalEl ? new bootstrap.Modal(actionModalEl) : null;
  const timeModalEl    = document.getElementById("timeModal");
  const timeModal      = timeModalEl ? new bootstrap.Modal(timeModalEl) : null;
  const paxListModalEl = document.getElementById("paxListModal");
  const paxListModal   = paxListModalEl ? new bootstrap.Modal(paxListModalEl) : null;
  const seatmapModalEl = document.getElementById("seatmapModal");
  const seatmapModal   = seatmapModalEl ? new bootstrap.Modal(seatmapModalEl) : null;

  const ctxMenu         = document.getElementById("flightContextMenu");
  const ctxDepartureBtn = document.getElementById("ctx-departure");
  const ctxArrivalBtn   = document.getElementById("ctx-arrival");

  function hideContextMenu() {
    if (ctxMenu) ctxMenu.style.display = "none";
  }
  document.addEventListener("click", hideContextMenu);

  // ---------- Gantt rendering ----------
  function renderGanttFromFlights(newFlights) {
    flights = newFlights || [];

    if (!flights.length) {
      rowsContainer.innerHTML = "";
      axisEl.innerHTML = "";
      byReg = {};
      regs  = [];
      return;
    }

    // Time window
    let minStd = flights[0].stdEst;
    let maxEta = flights[0].staEst;
    flights.forEach(f => {
      if (f.stdEst && f.stdEst < minStd) minStd = f.stdEst;
      if (f.staEst && f.staEst > maxEta) maxEta = f.staEst;
    });

    chartStart = new Date(minStd.getTime() - 60 * 60000);
    chartEnd   = new Date(maxEta.getTime() + 60 * 60000);
    durationMs = chartEnd - chartStart;

    // Axis
    axisEl.innerHTML = "";
    const startHour = new Date(chartStart);
    startHour.setMinutes(0, 0, 0);
    for (let t = new Date(startHour); t <= chartEnd; t.setHours(t.getHours() + 1)) {
      const offset = (t - chartStart) / durationMs * 100;
      const tick   = document.createElement("div");
      tick.className = "tick";
      tick.style.left = offset + "%";

      const label = document.createElement("div");
      label.className = "tick-label";
      label.textContent = fmtTime(t);

      tick.appendChild(label);
      axisEl.appendChild(tick);
    }

    // Group by registration
    byReg = {};
    flights.forEach(f => {
      const regKey = f.reg || "UNKNOWN";
      if (!byReg[regKey]) byReg[regKey] = [];
      byReg[regKey].push(f);
    });
    regs = Object.keys(byReg).sort();

    // Re-render rows with current base filter
    const baseFilterSelect = document.getElementById("base-filter");
    const baseCode = baseFilterSelect ? (baseFilterSelect.value || "") : "";
    renderRowsForBase(baseCode);
  }

  // ---------- Rows / bars (with base filter) ----------
  function renderRowsForBase(baseCode) {
    rowsContainer.innerHTML = "";

    const base     = (baseCode || "").toUpperCase();
    const baseIcao = base ? (BASE_ICAO[base] || null) : null;

    regs.forEach(reg => {
      const flightsForReg = (byReg[reg] || []).slice().sort((a, b) => a.stdEst - b.stdEst);

      // Filter aircraft lines by base (either IATA or mapped ICAO)
      if (base) {
        const hasBaseFlight = flightsForReg.some(f => {
          const dep  = (f.dep || "").toUpperCase();
          const ades = (f.ades || "").toUpperCase();
          return (
            dep === base || ades === base ||
            (baseIcao && (dep === baseIcao || ades === baseIcao))
          );
        });
        if (!hasBaseFlight) return; // skip this aircraft
      }

      const row = document.createElement("div");
      row.className = "gantt-row";

      const labelCol = document.createElement("div");
      labelCol.className = "gantt-row-label";
      labelCol.textContent = reg;

      const track = document.createElement("div");
      track.className = "gantt-row-track";

      let lastArrAirport = null;

      flightsForReg.forEach(f => {
        const leftPct  = (f.stdEst - chartStart) / durationMs * 100;
        const widthPct = Math.max((f.staEst - f.stdEst) / durationMs * 100, 2);

        // scheduled bar (thin)
        if (f.stdSched && f.staSched) {
          const schedLeft  = (f.stdSched - chartStart) / durationMs * 100;
          const schedWidth = Math.max((f.staSched - f.stdSched) / durationMs * 100, 2);
          const schedBar = document.createElement("div");
          schedBar.className = "gantt-flight-sched";
          schedBar.style.left  = schedLeft + "%";
          schedBar.style.width = schedWidth + "%";
          track.appendChild(schedBar);
        }

        // actual bar (thick)
        const bar = document.createElement("div");
        bar.className = "gantt-flight status-" + (f.statusNorm || "unknown");
        bar.style.left  = leftPct + "%";
        bar.style.width = widthPct + "%";
        bar.dataset.flightId = f.id;

        const labelCode = `${f.designator || ""}${f.flightNumeric || f.flightFull || ""}`.trim();
        bar.innerHTML = `<span class="flight-main">${labelCode}</span>`;

        const hasActual = !!(f.depActual || f.arrActual);
        const startLabel = fmtTime(f.stdEst);
        const endLabel   = fmtTime(f.staEst);
        bar.title = `${labelCode}  ${f.dep} → ${f.ades}  (${startLabel}–${endLabel})` +
                    (hasActual ? " [ACT]" : "");


        bar.addEventListener("click", function (ev) {
          ev.preventDefault();
          currentFlight = f;
          currentBarEl  = bar;
          populateFlightDetailsModal(f);
          if (actionModal) actionModal.show();
        });

        bar.addEventListener("contextmenu", function (ev) {
          ev.preventDefault();
          currentFlight = f;
          currentBarEl  = bar;
          if (!ctxMenu) return;
          ctxMenu.style.left = ev.pageX + "px";
          ctxMenu.style.top  = ev.pageY + "px";
          ctxMenu.style.display = "block";
        });

        // airport labels
        if (!lastArrAirport || f.dep !== lastArrAirport) {
          const depLbl = document.createElement("div");
          depLbl.className = "gantt-airport-label dep";
          depLbl.textContent = f.dep;
          depLbl.style.left = leftPct + "%";
          track.appendChild(depLbl);
        }

        const arrLbl = document.createElement("div");
        arrLbl.className = "gantt-airport-label arr";
        arrLbl.textContent = f.ades;
        arrLbl.style.left = (leftPct + widthPct) + "%";
        track.appendChild(arrLbl);
        lastArrAirport = f.ades;

        track.appendChild(bar);
      });

      row.appendChild(labelCol);
      row.appendChild(track);
      rowsContainer.appendChild(row);
    });
  }

  const baseFilterSelect = document.getElementById("base-filter");
  if (baseFilterSelect) {
    baseFilterSelect.addEventListener("change", function () {
      renderRowsForBase(this.value || "");
    });
  }

// ---------- Passenger status classifier ----------
function classifyPaxStatus(p) {
  const raw =
    (p.DCSStatus       || p.DcsStatus      ||
     p.Status          || p.status         ||
     p.CheckInStatus   || p.checkInStatus  ||
     p.BoardingStatus  || p.boardingStatus ||
     ""
    ).toString().toUpperCase();

  const explicitFlown =
    p.Flown === true || p.flown === true;

  // Highest state first: FLOWN → BOARDED → CHECKED → BOOKED
  if (explicitFlown || raw.includes("FLOWN") || raw === "FLWN") {
    return "FLOWN";
  }

  if (p.Boarded === true || p.boarded === true) {
    return "BOARDED";
  }
  if (p.CheckedIn === true || p.checkedIn === true) {
    return "CHECKED";
  }

  if (!raw) return "BOOKED";

  if (raw.includes("FLOWN") || raw === "FLWN") return "FLOWN";
  if (raw.includes("BOARD")) return "BOARDED";
  if (raw.includes("CHECK")) return "CHECKED";

  if (raw === "CI"  || raw === "CKIN" || raw === "CKI") return "CHECKED";
  if (raw === "BD"  || raw === "BRD")                 return "BOARDED";

  return "BOOKED";
}


// ---------- Flight details modal ----------
function populateFlightDetailsModal(f) {
  const codeEl      = document.getElementById("modal-flight-code");
  const routeEl     = document.getElementById("modal-route");
  const acEl        = document.getElementById("modal-aircraft");
  const stdStaEl    = document.getElementById("modal-std-sta");
  const etdEtaEl    = document.getElementById("modal-etd-eta");
  const atdAtaEl    = document.getElementById("modal-atd-ata");
  const statusEl    = document.getElementById("modal-status");
  const paxBrkEl    = document.getElementById("modal-pax-breakdown");
  const paxTypesEl  = document.getElementById("modal-pax-types");
  const bagsEl      = document.getElementById("modal-bags");
  const warningsEl  = document.getElementById("flight-warnings");

  const labelCode = `${f.designator || ""}${f.flightNumeric || f.flightFull || ""}`.trim();

  if (codeEl)  codeEl.textContent  = labelCode;
  if (routeEl) routeEl.textContent = `${f.dep} → ${f.ades}`;
  if (acEl)    acEl.textContent    = f.reg;

  const stdTxt = f.stdSched ? fmtTime(f.stdSched) : "—";
  const staTxt = f.staSched ? fmtTime(f.staSched) : "—";
  if (stdStaEl) stdStaEl.textContent = `${stdTxt} / ${staTxt}`;

  const etdTxt = fmtTime(f.stdEst);
  const etaTxt = fmtTime(f.staEst);
  if (etdEtaEl) etdEtaEl.textContent = `${etdTxt || "—"} / ${etaTxt || "—"}`;

  if (statusEl) statusEl.textContent = f.statusRaw || "Unknown";

  // --- Passenger breakdown (stacked, including FLOWN) ---
  const paxList = Array.isArray(f.paxList) ? f.paxList : [];
  let bookedTotal  = 0;
  let checkedTotal = 0;
  let boardedTotal = 0;
  let flownTotal   = 0;

  paxList.forEach(p => {
    const bucket = classifyPaxStatus(p);
    switch (bucket) {
      case "FLOWN":
        flownTotal++;
        break;
      case "BOARDED":
        boardedTotal++;
        break;
      case "CHECKED":
        checkedTotal++;
        break;
      default: // BOOKED or anything else
        bookedTotal++;
        break;
    }
  });

  const totalDisplay = f.paxTotal || paxList.length;
  const typeStr = `Total: ${totalDisplay} (AD ${f.paxAdt} / CHD ${f.paxChd} / INF ${f.paxInf})`;

  if (paxBrkEl) {
    paxBrkEl.innerHTML = `
      <div class="pax-line">
        <span class="pax-label">Booked</span>
        <span class="pax-value">${bookedTotal}</span>
      </div>
      <div class="pax-line">
        <span class="pax-label">Checked-in</span>
        <span class="pax-value">${checkedTotal}</span>
      </div>
      <div class="pax-line">
        <span class="pax-label">Boarded</span>
        <span class="pax-value">${boardedTotal}</span>
      </div>
      <div class="pax-line">
        <span class="pax-label">Flown</span>
        <span class="pax-value">${flownTotal}</span>
      </div>
      <div class="pax-line mt-1">
        <span class="pax-label">Total</span>
        <span class="pax-value">${totalDisplay}</span>
      </div>
    `;
  }

  if (paxTypesEl) {
    paxTypesEl.textContent = typeStr;
  }

  if (paxTypesEl) {
    paxTypesEl.textContent = typeStr;
  }

  if (bagsEl) bagsEl.textContent = (f.bagsKg || 0).toFixed(1);

  // ---- Warnings (DCS + APG) with hover details ----
  if (warningsEl) {
    const hasDcs = Array.isArray(f.paxList) && f.paxList.length > 0;
    const hasApg = !!(f.apgPlanId && f.apgPlanId.toString().trim());

    const flightDate = formatDateYMD(f.stdEst || f.stdSched);
    const etdText    = fmtTime(f.stdEst);
    const etaText    = fmtTime(f.staEst);

    const dcsTip = hasDcs
      ? `DCS flight key:\n  ${labelCode}  ${f.dep} → ${f.ades}\n  Date: ${flightDate}\n  ETD/ETA (local): ${etdText} / ${etaText}`
      : `No DCS passenger list linked for:\n  ${labelCode}  ${f.dep} → ${f.ades}\n  Date: ${flightDate}`;

    const apgTip = hasApg
      ? `APG plan ID: ${f.apgPlanId}\nMatched using:\n  ${labelCode}  ${f.dep} → ${f.ades}\n  Date: ${flightDate}`
      : `No APG plan ID is currently linked to:\n  ${labelCode}  ${f.dep} → ${f.ades}\n  Date: ${flightDate}`;

    let html = "";

    html += hasDcs
      ? `<span class="badge bg-success me-1" title="${dcsTip.replace(/"/g, "&quot;")}">DCS linked</span>`
      : `<span class="badge bg-secondary me-1" title="${dcsTip.replace(/"/g, "&quot;")}">No DCS pax</span>`;

    html += hasApg
      ? `<span class="badge bg-success" title="${apgTip.replace(/"/g, "&quot;")}">APG plan</span>`
      : `<span class="badge bg-warning text-dark" title="${apgTip.replace(/"/g, "&quot;")}">No APG plan</span>`;

    warningsEl.innerHTML = html;
  }

  // ---- Delays table (kept inside Q3) ----
  const delaysEl = document.getElementById("modal-delays");
  if (delaysEl) {
    const delays = Array.isArray(f.delays) ? f.delays : [];

    if (!delays.length) {
      delaysEl.innerHTML = '<span class="text-muted">No delays recorded.</span>';
    } else {
      const rowsHtml = delays.map(d => {
        const code = d.code || d.delayCode || "";
        const mins = d.delayMinutes || d.minutes || 0;
        const leg  = d.isArrival ? "ARR" : "DEP";
        const meta = DELAY_CODE_META[code] || null;
        const desc = d.description || (meta ? meta.description : "");

        return `
          <tr>
            <td>${leg}</td>
            <td>${code}</td>
            <td class="text-end">${mins}</td>
            <td>${desc}</td>
          </tr>
        `;
      }).join("");

      delaysEl.innerHTML = `
        <div class="table-responsive">
          <table class="table table-sm mb-0">
            <thead>
              <tr>
                <th>Leg</th>
                <th>Code</th>
                <th class="text-end">Min</th>
                <th>Description</th>
              </tr>
            </thead>
            <tbody>
              ${rowsHtml}
            </tbody>
          </table>
        </div>
      `;
    }
  }

  // ---- ATD / ATA from Envision ----
  if (atdAtaEl) {
    atdAtaEl.textContent = "— / —";

    if (typeof fetchEnvisionTimes === "function" && f.envisionFlightId) {
      fetchEnvisionTimes(f.envisionFlightId).then(data => {
        if (!data || !data.local_hm) return;
        const hm = data.local_hm;

        const atd = hm.departureActual || "";
        const ata = hm.arrivalActual   || "";

        const atdText = atd || "—";
        const ataText = ata || "—";
        atdAtaEl.textContent = `${atdText} / ${ataText}`;
      });
    }
  }
}

  // ---------- APG push ----------
// --- send to APG with pending icon + stronger payload building ---
function sendToFlightPlan(f, barEl) {
  if (!f) return;

  // Button feedback
  const sendBtn = document.getElementById("btn-send-apg");
  let originalBtnHtml = "";
  if (sendBtn) {
    originalBtnHtml = sendBtn.innerHTML;
    sendBtn.disabled = true;
    sendBtn.innerHTML =
      '<span class="spinner-border spinner-border-sm me-1" role="status" aria-hidden="true"></span>Sending…';
  }

  // Bar feedback
  if (barEl) barEl.classList.add("sending");

  // --- Build required fields safely ---
  // Flight date: prefer ETD, fall back to STD
  const dt = f.stdEst || f.stdSched || null;
  const dateStr = dt ? dt.toISOString().slice(0, 10) : null;

  // Plan ID: from our model
  const apgPlanId = (f.apgPlanId || f.apg_plan_id || "").toString().trim() || null;

  // Designator + flight number parsing
  let designator = (f.designator || "").toString().trim().toUpperCase();
  let fullNo =
    (f.flightFull ||
      f.flight ||
      (designator && f.flightNumeric ? designator + f.flightNumeric : "") ||
      "").toString().replace(/\s+/g, "").toUpperCase();

  // If we still don't have a designator, try to infer from fullNo
  if (!designator && fullNo) {
    const m = fullNo.match(/^([A-Z]{1,3})?(\d+)/);
    if (m) {
      if (m[1]) designator = m[1];
    }
  }

  // Numeric part: last run of digits
  let number = "";
  if (fullNo) {
    const m2 = fullNo.match(/(\d+)$/);
    if (m2) number = m2[1];
  }
  // If no fullNo yet but we have designator + numeric, build it
  if (!fullNo && designator && f.flightNumeric) {
    number = f.flightNumeric.toString();
    fullNo = (designator + number).toUpperCase();
  }

  const baseRequest = {
    apg_plan_id: apgPlanId,
    dep: (f.dep || "").toString().toUpperCase(),
    date: dateStr,
    designator: designator,
    flight_number: fullNo || null,
    pax_list: Array.isArray(f.paxList) ? f.paxList : []
  };


  console.log("[APG] sending payload:", baseRequest);

  // If anything critical is missing, abort nicely
  if (!baseRequest.apg_plan_id ||
      !baseRequest.dep ||
      !baseRequest.date ||
      !baseRequest.designator ||
      !baseRequest.flight_number) {

    console.error("[APG] missing required fields:", baseRequest);
    alert("Cannot send to Flight Plan: missing required data (check console).");

    if (sendBtn) {
      sendBtn.disabled = false;
      sendBtn.innerHTML = originalBtnHtml;
    }
    if (barEl) barEl.classList.remove("sending");
    return;
  }

  // --- Do preview then actual send ---
  fetch("/api/dcs/push_to_apg", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ ...baseRequest, preview_only: true })
  })
    .then(r => r.json())
    .then(data => {
      if (!data.ok) throw new Error(data.error || "Preview failed");
      console.log("[APG] preview OK:", data);

      return fetch("/api/dcs/push_to_apg", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ ...baseRequest, preview_only: false })
      });
    })
    .then(r => r.json())
    .then(data => {
      if (!data.ok) throw new Error(data.error || "APG push failed");

      console.log("[APG] send OK:", data);

      // Bar visual
      if (barEl) {
        barEl.classList.remove("sending");
        barEl.classList.add("sent");
      }

      // Button success state
      if (sendBtn) {
        sendBtn.innerHTML = "Sent ✓";
        setTimeout(() => {
          sendBtn.disabled = false;
          sendBtn.innerHTML = originalBtnHtml;
        }, 2000);
      }

      if (data.plan_id) {
        loadApgPlanDetails(data.plan_id);
      }
    })
    .catch(err => {
      console.error("[APG] send error:", err);
      alert("Error sending to Flight Plan: " + err.message);

      if (sendBtn) {
        sendBtn.disabled = false;
        sendBtn.innerHTML = originalBtnHtml;
      }
      if (barEl) barEl.classList.remove("sending");
    });
}

// --- Reset APG plan for the current flight ---
async function resetFlightPlan(f, barEl) {
  if (!f) return;

  const resetBtn = document.getElementById("btn-reset-apg");
  if (!resetBtn) return;

  const dt = f.stdEst || f.stdSched || null;
  const dateStr = dt ? dt.toISOString().slice(0, 10) : null;

  const apgPlanId = (f.apgPlanId || f.apg_plan_id || "").toString().trim() || null;

  const payload = {
    apg_plan_id: apgPlanId,
    dep: (f.dep || "").toString().toUpperCase(),
    date: dateStr,
    designator: (f.designator || "").toString().toUpperCase(),
    flight_number:
      (f.flightFull ||
        (f.designator || "") + (f.flightNumeric || "")).
        toString().replace(/\s+/g, "").toUpperCase()
  };

  if (!payload.apg_plan_id || !payload.dep || !payload.date || !payload.designator || !payload.flight_number) {
    alert("Cannot reset APG plan: missing required data.");
    return;
  }

  if (!confirm(`Reset APG plan ${payload.apg_plan_id} for ${payload.designator}${payload.flight_number}?`)) {
    return;
  }

  resetBtn.disabled = true;
  const originalText = resetBtn.textContent;
  resetBtn.textContent = "Resetting…";

  if (barEl) barEl.classList.add("sending");

  try {
    const resp = await fetch("/api/dcs/reset_apg", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload),
    });

    const data = await resp.json().catch(() => ({}));

    if (!resp.ok || !data.ok) {
      throw new Error(data.error || resp.statusText || "Reset failed");
    }

    alert("APG plan has been reset.");
    if (barEl) {
      barEl.classList.remove("sending");
      barEl.classList.remove("sent");
    }
  } catch (err) {
    console.error("[APG] reset error:", err);
    alert("Error resetting APG plan: " + err.message);
    if (barEl) barEl.classList.remove("sending");
  } finally {
    resetBtn.disabled = false;
    resetBtn.textContent = originalText;
  }
}

// Wire the reset button
const resetBtn = document.getElementById("btn-reset-apg");
if (resetBtn) {
  resetBtn.addEventListener("click", function () {
    if (!currentFlight) {
      alert("Please select a flight on the Gantt first.");
      return;
    }
    resetFlightPlan(currentFlight, currentBarEl);
  });
}

  async function loadApgPlanDetails(planId) {
    const detailsEl = document.getElementById("apg-plan-details");
    const idSpan    = document.getElementById("apg-plan-id");
    const jsonPre   = document.getElementById("apg-plan-json");
    if (!detailsEl || !idSpan || !jsonPre) return;

    try {
      const res  = await fetch(`/api/apg/plan/${planId}`);
      const data = await res.json();
      if (!res.ok || !data.ok) return;
      idSpan.textContent      = planId;
      jsonPre.textContent     = JSON.stringify(data.plan, null, 2);
      detailsEl.style.display = "";
      detailsEl.open          = true;
    } catch (err) {
      console.error("Error fetching APG plan:", err);
    }
  }

  const sendBtn = document.getElementById("btn-send-apg");
  if (sendBtn) {
    sendBtn.addEventListener("click", function () {
      if (!currentFlight || !currentBarEl) return;
      sendToFlightPlan(currentFlight, currentBarEl);
    });
  }

    // ---------- Envision: load actual times for a flight ----------

  function fetchEnvisionTimes(envisionFlightId) {
    if (!envisionFlightId) {
      return Promise.resolve(null);
    }

    return fetch(`/api/envision/flight_times?flight_id=${encodeURIComponent(envisionFlightId)}`)
      .then(r => r.json())
      .then(data => {
        if (!data.ok) {
          console.warn("Envision /flight_times error:", data.error || data);
          return null;
        }
        return data;  // { local_hm: { departureActual, departureTakeOff, arrivalLanded, arrivalActual }, ... }
      })
      .catch(err => {
        console.error("Envision /flight_times fetch failed:", err);
        return null;
      });
  }

  function formatDob(dobStr) {
    if (!dobStr) return "";
    const d = new Date(dobStr);
    if (isNaN(d.getTime())) return dobStr;
    const y = d.getFullYear();
    const m = String(d.getMonth() + 1).padStart(2, "0");
    const day = String(d.getDate()).padStart(2, "0");
    return `${y}-${m}-${day}`;
  }

  function calcAge(dobStr) {
    if (!dobStr) return "";
    const d = new Date(dobStr);
    if (isNaN(d.getTime())) return "";
    const today = new Date();
    let age = today.getFullYear() - d.getFullYear();
    const m = today.getMonth() - d.getMonth();
    if (m < 0 || (m === 0 && today.getDate() < d.getDate())) age--;
    return age;
  }

  function getField(obj, candidates, fallback = "") {
    for (const c of candidates) {
      if (obj[c] !== undefined && obj[c] !== null && obj[c] !== "") {
        return obj[c];
      }
    }
    return fallback;
  }

  // Seat parsing helper for sorting "12C"
  function parseSeatCode(seatStr) {
    if (!seatStr) return { row: Number.MAX_SAFE_INTEGER, col: "" };
    const s = seatStr.toString().trim().toUpperCase();
    const m = s.match(/^(\d+)([A-Z]+)$/);
    if (!m) return { row: Number.MAX_SAFE_INTEGER, col: s };
    return {
      row: parseInt(m[1], 10),
      col: m[2],
    };
  }

  function sortPaxTable(colIndex, ascending) {
    const table = document.getElementById("pax-list-table");
    const tbody = document.getElementById("pax-list-body");
    if (!table || !tbody) return;

    const rows = Array.from(tbody.querySelectorAll("tr"));
    if (!rows.length) return;

    rows.sort((a, b) => {
      const aText = (a.children[colIndex]?.textContent || "").trim();
      const bText = (b.children[colIndex]?.textContent || "").trim();

      if (colIndex === 0) {
        const aSeat = parseSeatCode(aText);
        const bSeat = parseSeatCode(bText);
        if (aSeat.row !== bSeat.row)
          return ascending ? (aSeat.row - bSeat.row) : (bSeat.row - aSeat.row);
        if (aSeat.col < bSeat.col) return ascending ? -1 : 1;
        if (aSeat.col > bSeat.col) return ascending ? 1 : -1;
        return 0;
      }

      if (colIndex === 3) {
        const aNum = parseInt(aText || "0", 10);
        const bNum = parseInt(bText || "0", 10);
        if (isNaN(aNum) && isNaN(bNum)) return 0;
        if (isNaN(aNum)) return ascending ? 1 : -1;
        if (isNaN(bNum)) return ascending ? -1 : 1;
        return ascending ? (aNum - bNum) : (bNum - aNum);
      }

      if (aText < bText) return ascending ? -1 : 1;
      if (aText > bText) return ascending ? 1 : -1;
      return 0;
    });

    rows.forEach(row => tbody.appendChild(row));
  }

  (function setupPaxTableHeaderSort() {
    const table = document.getElementById("pax-list-table");
    if (!table) return;

    const headers = table.querySelectorAll("thead th");
    headers.forEach((th, idx) => {
      th.style.cursor = "pointer";
      th.dataset.sortDir = "none";

      th.addEventListener("click", () => {
        const current = th.dataset.sortDir;
        const newDir = (current === "asc") ? "desc" : "asc";

        headers.forEach(h => h.dataset.sortDir = "none");
        th.dataset.sortDir = newDir;

        sortPaxTable(idx, newDir === "asc");
      });
    });
  })();

  function populatePassengerListModal(passengers) {
    const tbody = document.getElementById("pax-list-body");
    if (!tbody) return;

    tbody.innerHTML = "";

    (passengers || []).forEach((p) => {
      const name =
        (
          getField(p, ["Name", "FullName", "PassengerName"], "") ||
          (
            (getField(p, ["NamePrefix"], "") + " " +
             getField(p, ["GivenName", "FirstName"], "") + " " +
             getField(p, ["Surname", "LastName"], ""))
          )
        ).trim();

      const dob   = getField(p, ["DateOfBirth", "BirthDate", "DOB"], "");
      const age   = calcAge(dob);
      const seat  = getField(p, ["Seat", "SeatNo", "SeatNumber"], "");
      const pnr   = getField(p, ["BookingReferenceID", "PNR", "PnrCode", "RecordLocator"], "");
      const statusBucket = classifyPaxStatus(p);
      let statusLabel = "";
      switch (statusBucket) {
        case "BOOKED":  statusLabel = "Booked";      break;
        case "CHECKED": statusLabel = "Checked-in";  break;
        case "BOARDED": statusLabel = "Boarded";     break;
        case "FLOWN":   statusLabel = "Flown";       break;
        default:        statusLabel = statusBucket || ""; break;
      }

      const ssrs = getField(p, ["Ssrs", "SSRs", "SpecialServiceRequests"], []);
      let ssrText = "";
      if (Array.isArray(ssrs)) {
        ssrText = ssrs
          .map((s) => {
            const c   = (s.Code || s.code || "").toUpperCase();
            const txt = s.FreeText || s.freeText || "";
            return txt ? `${c} (${txt})` : c;
          })
          .filter(Boolean)
          .join(", ");
      } else if (typeof ssrs === "string") {
        ssrText = ssrs;
      }

      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${seat}</td>
        <td>${name}</td>
        <td>${dob ? dob.substring(0, 10) : ""}</td>
        <td>${age ? age : ""}</td>
        <td>${pnr}</td>
        <td>${statusLabel}</td>
        <td>${ssrText}</td>
      `;
      tbody.appendChild(tr);
    });

    // default sort: seat ascending
    sortPaxTable(0, true);
  }

  const viewPaxBtn = document.getElementById("btn-view-pax");
  if (viewPaxBtn && paxListModal) {
    viewPaxBtn.addEventListener("click", function () {
      if (!currentFlight) return;
      populatePassengerListModal(currentFlight.paxList || []);
      paxListModal.show();
    });
  }

  // ---------- Seatmap ----------
  const SSR_SPECIAL = new Set(["CKIN", "DEAF", "PETC", "VVIP", "UNZZ","UMNR"]);

  function hasWheelchairSSR(ssrs) {
    if (!Array.isArray(ssrs)) return false;
    return ssrs.some(s => {
      const code = (s.Code || s.code || "").toUpperCase();
      return code.startsWith("WC");
    });
  }

  function hasSpecialSSR(ssrs) {
    if (!Array.isArray(ssrs)) return false;
    return ssrs.some(s => {
      const code = (s.Code || s.code || "").toUpperCase();
      return SSR_SPECIAL.has(code);
    });
  }

  function hasInfantSSR(ssrs) {
    if (!Array.isArray(ssrs)) return false;
    return ssrs.some(s => {
      const code = (s.Code || s.code || "").toUpperCase();
      return code === "INFT" || code === "INF";
    });
  }

  const seatmapConfigs = {
    SF3_STD: {
      name: "SF340A",
      rows: [1,2,3,4,5,6,7,8,9,10,11],
      left: ["A"],
      right: ["B","C"],
      lastRowMode: "4-inline",
      hasRow0C: false,
    },
    SF3_CIZ: {
      name: "SF340B",
      rows: [1,2,3,4,5,6,7,8,9,10,11],
      left: ["A"],
      right: ["B","C"],
      lastRowMode: "4-inline",
      hasRow0C: false,
    },
    SF3_CIT: {
      name: "SF340A",
      rows: [0,1,2,3,4,5,6,7,8,9,10,11],
      left: ["A"],
      right: ["B","C"],
      lastRowMode: null,
      hasRow0C: true,
    },
    
    ATR72: {
      name: "ATR 72",
      rows: [1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17],
      left: ["A","B"],
      right:["C","D"],
      lastRowMode: null,
      hasRow0C: false,
    },
  };

  function seatmapKeyForFlight(f) {
    const t = (f.aircraftType || "").toUpperCase();
    const r = (f.reg || "").toUpperCase();

    if (t.includes("ATR") || r.includes("MCU")) return "ATR72";

    const isSaab =
      t.includes("SAAB") ||
      t.includes("SF3") ||
      t.includes("SF34") ||
      t.includes("SF340") ||
      r.startsWith("ZK-CI") ||
      r.startsWith("ZK-KR");

    if (isSaab) {
      if (r === "ZK-CIT") return "SF3_CIT";
      if (r === "ZK-CIZ") return "SF3_CIZ";
      return "SF3_STD";
    }

    return null;
  }

  function buildSeatmapForFlight(f) {
    const container = document.getElementById("seatmap-container");
    const infoEl    = document.getElementById("seatmap-info");
    const titleEl   = document.getElementById("seatmapModalLabel");
    if (!container || !infoEl || !titleEl) return;

    container.innerHTML = "";
    infoEl.textContent = "Click a seat to see passenger details.";

    const key = seatmapKeyForFlight(f);
    const cfg = key ? seatmapConfigs[key] : null;

    if (!cfg) {
      titleEl.textContent = `Seat map — ${f.reg}`;
      infoEl.textContent  = "Seatmap not available for this aircraft type.";
      return;
    }

    titleEl.textContent = `Seat map — ${cfg.name} (${f.reg})`;

    const paxBySeat = {};
    (f.paxList || []).forEach(p => {
      const seat = (p.Seat || p.SeatNumber || "").toString().toUpperCase();
      if (seat) paxBySeat[seat] = p;
    });

    function makeSeat(rowNum, col) {
      const seatCode = `${rowNum}${col}`;
      const seatEl   = document.createElement("div");
      seatEl.className = "seat";
      seatEl.textContent = col;
      seatEl.dataset.seat = seatCode;

      const pax = paxBySeat[seatCode];

      if (pax) {
        const ssrsForSeat = getField(pax, ["Ssrs","SSRs","SpecialServiceRequests"], []);
        const paxType     = (pax.PassengerType || pax.passengerType || "").toUpperCase();
        const isUmnr      = hasUmnrSSR(ssrsForSeat);

        // --- Base colour: treat UMNR as a child visually ---
        if (isUmnr || paxType === "CH" || paxType === "CHD") {
          seatEl.classList.add("seat-child");
        } else if (hasInfantSSR(ssrsForSeat)) {
          seatEl.classList.add("seat-adult-infant");
        } else {
          seatEl.classList.add("seat-adult");
        }

        const iconsDiv = document.createElement("div");
        iconsDiv.className = "seat-icons";

        // UMNR child icon + red border
        if (isUmnr) {
          seatEl.classList.add("seat-umnr");

          const um = document.createElement("span");
          um.className = "seat-icon seat-icon-umnr";
          um.textContent = "🧒";   // small child emoji
          iconsDiv.appendChild(um);
        }

        if (hasSpecialSSR(ssrsForSeat)) {
          const sp = document.createElement("span");
          sp.className = "seat-icon seat-icon-special";
          sp.textContent = "!";
          iconsDiv.appendChild(sp);
        }

        if (hasWheelchairSSR(ssrsForSeat)) {
          const wc = document.createElement("span");
          wc.className = "seat-icon seat-icon-wheelchair";
          wc.textContent = "♿";
          iconsDiv.appendChild(wc);
        }

        if (iconsDiv.children.length > 0) {
          seatEl.appendChild(iconsDiv);
        }
      } else {
        seatEl.classList.add("seat-empty");
      }

      seatEl.addEventListener("click", function () {
        container.querySelectorAll(".seat.selected").forEach(el => el.classList.remove("selected"));
        seatEl.classList.add("selected");

        const pax = paxBySeat[seatCode];
        if (pax) {
          const name = [
            pax.NamePrefix || "",
            pax.GivenName || pax.FirstName || "",
            pax.Surname   || pax.LastName  || ""
          ].join(" ").trim();

          const dobRaw = pax.DateOfBirth || pax.BirthDate || "";
          const dob    = formatDob(dobRaw);
          const age    = calcAge(dobRaw);
          const pnr    = pax.BookingReferenceID || "";
          const ssrsArray = Array.isArray(pax.Ssrs) ? pax.Ssrs : [];
          let ssrs = "";
          if (ssrsArray.length) {
            ssrs = ssrsArray.map(s => {
              const code = s.Code || "";
              const text = s.FreeText || "";
              return text ? `${code} (${text})` : code;
            }).join(", ");
          }

          const isUmnr = hasUmnrSSR(ssrsArray);

          infoEl.innerHTML = `
            <div><strong>${seatCode}</strong></div>
            <div>${name}</div>
            <div>DOB: ${dob || "—"}${age ? ` (${age} yrs)` : ""}</div>
            <div>PNR: ${pnr || "—"}</div>
            <div>SSR: ${ssrs || "—"}</div>
            ${isUmnr ? `<div class="mt-1 text-danger"><strong>Unaccompanied minor</strong> 🧒</div>` : ""}
          `;
        } else {
          infoEl.innerHTML = `<strong>${seatCode}</strong><br>Empty seat`;
        }
      });

      return seatEl;
    }

    container.innerHTML = "";
    const lastRowNumber = cfg.rows[cfg.rows.length - 1];

    cfg.rows.forEach(rowNum => {
      const rowDiv = document.createElement("div");
      rowDiv.className = "seat-row";

      const label = document.createElement("div");
      label.className = "seat-label";
      label.textContent = rowNum;
      rowDiv.appendChild(label);

      const isRow0C          = cfg.hasRow0C && rowNum === 0;
      const isLastRow4Inline = cfg.lastRowMode === "4-inline" && rowNum === lastRowNumber;

      if (isRow0C) {
        const ghostA = document.createElement("div");
        ghostA.className = "seat";
        ghostA.style.visibility = "hidden";
        const ghostB = document.createElement("div");
        ghostB.className = "seat";
        ghostB.style.visibility = "hidden";

        const leftBlock = document.createElement("div");
        leftBlock.className = "seat-block";
        leftBlock.appendChild(ghostA);
        leftBlock.appendChild(ghostB);
        rowDiv.appendChild(leftBlock);

        const aisle = document.createElement("div");
        aisle.className = "seat-aisle";
        rowDiv.appendChild(aisle);

        const rightBlock = document.createElement("div");
        rightBlock.className = "seat-block";
        rightBlock.appendChild(makeSeat(rowNum, "C"));
        rowDiv.appendChild(rightBlock);

        container.appendChild(rowDiv);
        return;
      }

      if (isLastRow4Inline) {
        const block = document.createElement("div");
        block.className = "seat-block";
        ["A", "B", "C", "D"].forEach(col => block.appendChild(makeSeat(rowNum, col)));
        rowDiv.appendChild(block);
        container.appendChild(rowDiv);
        return;
      }

      const leftCols  = cfg.left.slice();
      const rightCols = cfg.right.slice();

      const leftBlock = document.createElement("div");
      leftBlock.className = "seat-block";
      leftCols.forEach(col => leftBlock.appendChild(makeSeat(rowNum, col)));
      rowDiv.appendChild(leftBlock);

      const aisle = document.createElement("div");
      aisle.className = "seat-aisle";
      rowDiv.appendChild(aisle);

      const rightBlock = document.createElement("div");
      rightBlock.className = "seat-block";
      rightCols.forEach(col => rightBlock.appendChild(makeSeat(rowNum, col)));
      rowDiv.appendChild(rightBlock);

      container.appendChild(rowDiv);
    });
  }

  const seatmapBtn = document.getElementById("btn-seatmap");
  if (seatmapBtn && seatmapModal) {
    seatmapBtn.addEventListener("click", function () {
      if (!currentFlight) return;
      buildSeatmapForFlight(currentFlight);
      seatmapModal.show();
    });
  }

  // ---------- Times / delay modal ----------
  function minutesBetween(t1, t2) {
    if (!t1 || !t2) return 0;
    return Math.round((t2 - t1) / 60000);
  }

  function recalcDelayAllocated() {
    const delayRows    = document.getElementById("delay-rows");
    const delayAllocEl = document.getElementById("delay-allocated");
    if (!delayRows || !delayAllocEl) return;
    const minsInputs = delayRows.querySelectorAll(".delay-minutes");
    let total = 0;
    minsInputs.forEach(inp => {
      const v = parseInt(inp.value || "0", 10);
      if (!isNaN(v)) total += v;
    });
    delayAllocEl.textContent = total.toString();
  }

    // ---------- Collect delay rows from modal ----------
function collectDelaysFromModal() {
  const rows = document.querySelectorAll("#delay-rows tr");
  const delays = [];
  const unknownCodes = new Set();
  const isArrival = (currentTimeMode === "arr");

  rows.forEach((tr) => {
    const codeInput   = tr.querySelector(".delay-code");
    const minsInput   = tr.querySelector(".delay-minutes");
    const remarkInput = tr.querySelector(".delay-remark");

    if (!codeInput || !minsInput) return;

    let code = (codeInput.value || "").trim();
    const mins = parseInt(minsInput.value || "0", 10);
    const remark = remarkInput ? (remarkInput.value || "").trim() : "";

    // Skip completely empty rows
    if (!code && !mins) return;

    // Normalise: strip non-digits and pad to two digits (e.g. "1" => "01")
    code = code.replace(/\D/g, "");
    if (!code) return;
    if (code.length === 1) code = "0" + code;

    if (isNaN(mins) || mins <= 0) return;

    const meta = DELAY_CODE_META[code];

    if (!meta) {
      unknownCodes.add(code);
      return;
    }

    delays.push({
      code: code,                    // "11", "81", etc.
      delayCodeId: meta.id,          // Envision ID from your table
      delayMinutes: mins,            // allocated minutes
      description: meta.description, // optional, for UI
      remark: remark,                // NEW
      isArrival: isArrival
    });
  });

  if (unknownCodes.size > 0) {
    alert(
      "Unknown delay code(s): " +
      Array.from(unknownCodes).join(", ") +
      "\nPlease fix these before saving."
    );
    return null; // abort save
  }

  return delays;
}

// --- Envision Time Helpers ---
function parseTimeToMinutes(hhmm) {
  if (!hhmm) return null;
  const [h, m] = hhmm.split(":").map(Number);
  if (Number.isNaN(h) || Number.isNaN(m)) return null;
  return h * 60 + m;
}

// Build a local wall-clock ISO "YYYY-MM-DDTHH:MM" from date + minutes
function datePlusMinutesToLocalIso(dateStr, minutes) {
  if (!dateStr || minutes == null) return null;
  const [y, mo, d] = dateStr.split("-").map(Number);
  const h = Math.floor(minutes / 60);
  const m = minutes % 60;
  const pad = n => String(n).padStart(2, "0");
  return `${y}-${pad(mo)}-${pad(d)}T${pad(h)}:${pad(m)}`;
}

function collectTimeModalPayload() {
  if (!currentFlight || !currentTimeMode) return null;

  // First, collect delay rows (and abort if any invalid codes)
  const delays = collectDelaysFromModal();
  if (delays === null) {
    // Invalid codes → do not send anything
    return null;
  }

  const getHm = (id) => {
    const el = document.getElementById(id);
    if (!el) return null;
    const v = (el.value || "").trim();
    return v && /^\d{1,2}:\d{2}$/.test(v) ? v : null;
  };

  const getDate = (id) => {
    const el = document.getElementById(id);
    if (!el) return null;
    const v = (el.value || "").trim();
    // HTML date: YYYY-MM-DD
    return v && /^\d{4}-\d{2}-\d{2}$/.test(v) ? v : null;
  };

  const base = {
    mode: currentTimeMode,
    dep: currentFlight.dep,
    ades: currentFlight.ades,
    designator: currentFlight.designator || "",
    flight_number:
      currentFlight.flightFull ||
      ((currentFlight.designator || "") + (currentFlight.flightNumeric || "")),
    std_sched: currentFlight.stdSched ? currentFlight.stdSched.toISOString() : null,
    sta_sched: currentFlight.staSched ? currentFlight.staSched.toISOString() : null,
    envision_flight_id: currentFlight.envisionFlightId || null,
    apg_plan_id: currentFlight.apgPlanId || null,
    delays: delays                      // <<< NEW: array of delay objects
  };

  if (currentTimeMode === "dep") {
    const depDate = getDate("dep-date");

    const etdHm   = getHm("time-etd");
    const offHm   = getHm("time-offblocks");
    const airHm   = getHm("time-airborne");

    const etdMinutes = parseTimeToMinutes(etdHm);
    const offMinutes = parseTimeToMinutes(offHm);
    let   airMinutes = parseTimeToMinutes(airHm);

    const etdLocalIso  = datePlusMinutesToLocalIso(depDate, etdMinutes);
    const offLocalIso  = datePlusMinutesToLocalIso(depDate, offMinutes);

    // Midnight crossing: 23:59 offblocks → 00:02 airborne next day
    let airLocalIso = null;
    if (airMinutes != null && offMinutes != null) {
      if (airMinutes < offMinutes) {
        airMinutes += 24 * 60;
      }
      airLocalIso = datePlusMinutesToLocalIso(depDate, airMinutes);
    }

    return {
      ...base,
      etd:       etdHm,
      offblocks: offHm,
      airborne:  airHm,
      dep_date:  depDate,
      arr_date:  null,
      etd_local:       etdLocalIso,
      offblocks_local: offLocalIso,
      airborne_local:  airLocalIso
    };
  } else {
    const arrDate = getDate("arr-date");

    const etaHm  = getHm("time-eta");
    const landHm = getHm("time-landing");
    const onHm   = getHm("time-onchocks");

    const etaMinutes  = parseTimeToMinutes(etaHm);
    const onMinutes   = parseTimeToMinutes(onHm);
    let   landMinutes = parseTimeToMinutes(landHm);

    const etaLocalIso = datePlusMinutesToLocalIso(arrDate, etaMinutes);
    const onLocalIso  = datePlusMinutesToLocalIso(arrDate, onMinutes);

    // Landing normally BEFORE on-blocks.
    if (landMinutes != null && onMinutes != null && landMinutes > onMinutes) {
      landMinutes -= 24 * 60; // previous day
    }
    const landLocalIso = datePlusMinutesToLocalIso(arrDate, landMinutes);

    return {
      ...base,
      eta:      etaHm,
      landing:  landHm,
      onchocks: onHm,
      dep_date: null,
      arr_date: arrDate,
      eta_local:      etaLocalIso,
      landing_local:  landLocalIso,
      onblocks_local: onLocalIso
    };
  }
}

function buildTimeModal(mode, flight) {
  currentTimeMode = mode;
  const core         = document.getElementById("time-modal-core");
  const delaySection = document.getElementById("delay-section");
  const delayRows    = document.getElementById("delay-rows");
  const delayReqEl   = document.getElementById("delay-required");
  const delayAllocEl = document.getElementById("delay-allocated");
  if (!core || !delaySection || !delayRows || !delayReqEl || !delayAllocEl) return;

  core.innerHTML = "";
  delayRows.innerHTML = "";
  delaySection.classList.add("d-none");
  delayReqEl.textContent   = "0";
  delayAllocEl.textContent = "0";

  const labelCode = `${flight.designator || ""}${flight.flightNumeric || flight.flightFull || ""}`.trim();
  const stdTxt = flight.stdSched ? fmtTime(flight.stdSched) : "—";
  const staTxt = flight.staSched ? fmtTime(flight.staSched) : "—";

  if (mode === "dep") {
    document.getElementById("timeModalLabel").textContent =
      `Departure Times — ${labelCode}`;

    core.innerHTML = `
      <div class="mb-2"><strong>${flight.dep} → ${flight.ades}</strong></div>
      <div class="mb-2 d-flex justify-content-between">
        <span>STD</span>
        <span>${stdTxt}</span>
      </div>

      <!-- ETD -->
      <div class="mb-2 d-flex justify-content-between align-items-center">
        <label class="me-2 mb-0">ETD</label>
        <input
          type="time"
          class="form-control form-control-sm w-auto"
          id="time-etd"
          value="${flight.stdEst ? fmtTime(flight.stdEst) : ""}">
      </div>

      <!-- Off blocks: DATE + TIME -->
      <div class="mb-2 d-flex justify-content-between align-items-center">
        <label class="me-2 mb-0">Off blocks</label>
        <div class="d-flex align-items-center gap-2">
          <input
            type="date"
            id="dep-date"
            class="form-control form-control-sm">
          <input
            type="time"
            class="form-control form-control-sm w-auto"
            id="time-offblocks">
        </div>
      </div>

      <!-- Airborne (uses same date as Off blocks for +1 logic) -->
      <div class="mb-2 d-flex justify-content-between align-items-center">
        <label class="me-2 mb-0">Airborne</label>
        <input
          type="time"
          class="form-control form-control-sm w-auto"
          id="time-airborne">
      </div>
    `;

    const depDateInput = document.getElementById("dep-date");
    if (depDateInput) {
      const defDate = formatDateYMD(
        flight.stdSched || flight.stdEst || new Date()
      );
      if (!depDateInput.value) depDateInput.value = defDate;
    }

    const etdInput      = document.getElementById("time-etd");
    const offInput      = document.getElementById("time-offblocks");
    const airborneInput = document.getElementById("time-airborne");

    function timeInputToDate(inputEl) {
      if (!flight.stdSched || !inputEl) return null;
      const raw = (
        inputEl.value ||
        inputEl.getAttribute("value") ||
        ""
      ).toString();

      const m = raw.match(/(\d{1,2}):(\d{2})/);
      if (!m) return null;

      const h  = parseInt(m[1], 10);
      const mi = parseInt(m[2], 10);

      const d = new Date(flight.stdSched);
      d.setHours(h, mi, 0, 0);
      return d;
    }

    function updateDelayDep() {
      if (!flight.stdSched) {
        delaySection.classList.add("d-none");
        delayReqEl.textContent   = "0";
        delayAllocEl.textContent = "0";
        return;
      }

      const offDt = timeInputToDate(offInput); // ATD

      // If no ATD entered, no delay required
      if (!offDt) {
        delaySection.classList.add("d-none");
        delayReqEl.textContent   = "0";
        delayAllocEl.textContent = "0";
        return;
      }

      let delayMins = minutesBetween(flight.stdSched, offDt);

      // Only positive delay counts – early departures shouldn't show delay
      if (delayMins < 0) {
        delayMins = 0;
      }

      if (delayMins > 15) {
        delaySection.classList.remove("d-none");
        delayReqEl.textContent = String(delayMins);
        recalcDelayAllocated();
      } else {
        delaySection.classList.add("d-none");
        delayReqEl.textContent   = "0";
        delayAllocEl.textContent = "0";
      }
    }


    if (etdInput) {
      etdInput.addEventListener("change", updateDelayDep);
      etdInput.addEventListener("input",  updateDelayDep);
    }
    if (offInput) {
      offInput.addEventListener("change", updateDelayDep);
      offInput.addEventListener("input",  updateDelayDep);
    }

    if (typeof fetchEnvisionTimes === "function" && flight.envisionFlightId) {
      fetchEnvisionTimes(flight.envisionFlightId).then(data => {
        if (!data || !data.local_hm) return;
        const hm = data.local_hm;

        if (hm.departureActual && offInput && !offInput.value) {
          offInput.value = hm.departureActual;
        }
        if (hm.departureTakeOff && airborneInput && !airborneInput.value) {
          airborneInput.value = hm.departureTakeOff;
        }
        if (hm.departureActual && etdInput && !etdInput.value) {
          etdInput.value = hm.departureActual;
        }

        updateDelayDep();
      });
    }

  } else {
    document.getElementById("timeModalLabel").textContent =
      `Arrival Times — ${labelCode}`;

    core.innerHTML = `
      <div class="mb-2"><strong>${flight.dep} → ${flight.ades}</strong></div>
      <div class="mb-2 d-flex justify-content-between">
        <span>STA</span>
        <span>${staTxt}</span>
      </div>

      <!-- ETA -->
      <div class="mb-2 d-flex justify-content-between align-items-center">
        <label class="me-2 mb-0">ETA</label>
        <input
          type="time"
          class="form-control form-control-sm w-auto"
          id="time-eta"
          value="${flight.staEst ? fmtTime(flight.staEst) : ""}">
      </div>

      <!-- Landing -->
      <div class="mb-2 d-flex justify-content-between align-items-center">
        <label class="me-2 mb-0">Landing</label>
        <input
          type="time"
          class="form-control form-control-sm w-auto"
          id="time-landing">
      </div>

      <!-- On chocks: DATE + TIME -->
      <div class="mb-2 d-flex justify-content-between align-items-center">
        <label class="me-2 mb-0">On chocks</label>
        <div class="d-flex align-items-center gap-2">
          <input
            type="date"
            id="arr-date"
            class="form-control form-control-sm">
          <input
            type="time"
            class="form-control form-control-sm w-auto"
            id="time-onchocks">
        </div>
      </div>
    `;

    const arrDateInput = document.getElementById("arr-date");
    if (arrDateInput) {
      const defDate = formatDateYMD(
        flight.staSched || flight.staEst || new Date()
      );
      if (!arrDateInput.value) arrDateInput.value = defDate;
    }

    const etaInput      = core.querySelector("#time-eta");
    const landingInput  = core.querySelector("#time-landing");
    const onChocksInput = core.querySelector("#time-onchocks");

    function updateDelayArr() {
      const etaVal = etaInput ? etaInput.value : "";
      if (!flight.staSched || !etaVal) {
        delaySection.classList.add("d-none");
        delayReqEl.textContent   = "0";
        delayAllocEl.textContent = "0";
        return;
      }
      const [h, m] = etaVal.split(":");
      const etaDt  = new Date(flight.staSched);
      etaDt.setHours(parseInt(h,10), parseInt(m,10), 0, 0);

      const diff = minutesBetween(flight.staSched, etaDt);
      if (Math.abs(diff) > 15) {
        delaySection.classList.remove("d-none");
        delayReqEl.textContent = diff.toString();
        recalcDelayAllocated();
      } else {
        delaySection.classList.add("d-none");
        delayReqEl.textContent   = "0";
        delayAllocEl.textContent = "0";
      }
    }

    if (etaInput) etaInput.addEventListener("change", updateDelayArr);

    if (typeof fetchEnvisionTimes === "function" && flight.envisionFlightId) {
      fetchEnvisionTimes(flight.envisionFlightId).then(data => {
        if (!data || !data.local_hm) return;
        const hm = data.local_hm;

        if (hm.arrivalLanded && landingInput && !landingInput.value) {
          landingInput.value = hm.arrivalLanded;
        }
        if (hm.arrivalActual && onChocksInput && !onChocksInput.value) {
          onChocksInput.value = hm.arrivalActual;
        }
        if (hm.arrivalActual && etaInput && !etaInput.value) {
          etaInput.value = hm.arrivalActual;
        }

        updateDelayArr();
      });
    }
  }
} // <--- close buildTimeModal here

// === Delay row add/handlers (outside buildTimeModal) ===
const addDelayBtn = document.getElementById("btn-add-delay");
if (addDelayBtn) {
  addDelayBtn.addEventListener("click", function () {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td style="width: 70px;">
        <input type="text"
               class="form-control form-control-sm delay-code"
               maxlength="4">
      </td>
      <td style="width: 90px;">
        <input type="number"
               class="form-control form-control-sm text-end delay-minutes"
               min="0">
      </td>
      <td>
        <input type="text"
               class="form-control form-control-sm delay-reason"
               placeholder="Auto from code"
               readonly>
      </td>
      <td>
        <input type="text"
               class="form-control form-control-sm delay-remark"
               placeholder="Optional remark">
      </td>
      <td class="text-end" style="width: 40px;">
        <button type="button"
                class="btn btn-sm btn-link text-danger p-0 btn-remove-delay">&times;</button>
      </td>
    `;

    const delayRows = document.getElementById("delay-rows");
    if (delayRows) {
      delayRows.appendChild(tr);
      attachDelayRowHandlers(tr);
      recalcDelayAllocated();
    }
  });
}

function attachDelayRowHandlers(tr) {
  const codeInput   = tr.querySelector(".delay-code");
  const minsInput   = tr.querySelector(".delay-minutes");
  const reasonInput = tr.querySelector(".delay-reason");
  const remBtn      = tr.querySelector(".btn-remove-delay");

  if (remBtn) {
    remBtn.addEventListener("click", function () {
      tr.remove();
      recalcDelayAllocated();
    });
  }

  if (minsInput) {
    minsInput.addEventListener("input", recalcDelayAllocated);
  }

  if (codeInput && reasonInput) {
    codeInput.addEventListener("input", function () {
      let raw = (codeInput.value || "").trim();
      raw = raw.replace(/\D/g, "");
      if (!raw) {
        reasonInput.value = "";
        return;
      }
      if (raw.length === 1) raw = "0" + raw;

      const meta = DELAY_CODE_META[raw];
      reasonInput.value = meta ? (meta.description || "") : "";
    });
  }
}

  if (ctxDepartureBtn) {
    ctxDepartureBtn.addEventListener("click", function () {
      hideContextMenu();
      if (!currentFlight || !timeModal) return;
      buildTimeModal("dep", currentFlight);
      timeModal.show();
    });
  }
  if (ctxArrivalBtn) {
    ctxArrivalBtn.addEventListener("click", function () {
      hideContextMenu();
      if (!currentFlight || !timeModal) return;
      buildTimeModal("arr", currentFlight);
      timeModal.show();
    });
  }
  const saveTimesBtn = document.getElementById("btn-save-times");
if (saveTimesBtn) {
  saveTimesBtn.addEventListener("click", async function () {
    const payload = collectTimeModalPayload();
    if (!payload) {
      alert("No flight / times to save.");
      return;
    }

    console.log("[TIMES] save payload:", payload);

    let resp;
    let data = null;

    try {
      resp = await fetch("/api/dcs/save_times", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload),
      });

      // Always log status
      console.log("[TIMES] HTTP status:", resp.status, resp.statusText);

      // Try to parse JSON, but don't crash if it's empty / HTML
      try {
        data = await resp.json();
      } catch (e) {
        console.warn("[TIMES] response was not JSON or was empty");
      }

      console.log("[TIMES] save response body:", data);

      if (!resp.ok) {
        const msg =
          (data && data.error) ||
          `HTTP ${resp.status} ${resp.statusText}` ||
          "Unknown error";
        alert("Backend reported an error saving times: " + msg);
        throw new Error(msg);
      }

      if (!data || !data.ok) {
        const msg =
          (data && data.error) ||
          "Backend returned ok=false with no details";
        alert("Backend reported an error saving times: " + msg);
        throw new Error(msg);
      }

      // Success path – you can add a toast here
      // e.g. showToast("Times saved to Envision");
    } catch (err) {
      console.error("[TIMES] save error:", err);
      alert("Error saving times: " + (err.message || err));
    } finally {
      if (timeModal) timeModal.hide();
    }
  });
}

  // ---------- Auto-refresh from backend ----------
  function refreshGantt() {
    const dateInput = document.querySelector('input[name="date"]');
    if (!dateInput) return;
    const dayStr = dateInput.value;

    // Show loading overlay only on the very first refresh
    if (firstRefresh) {
      setGanttLoading(true);
    }

    fetch(`/api/dcs/gantt_data?date=${encodeURIComponent(dayStr)}`)
      .then(r => r.json())
      .then(data => {
        if (!data.ok || !Array.isArray(data.results)) return;
        const newFlights = buildFlightsFromRows(data.results);
        renderGanttFromFlights(newFlights);

        const stamp = document.getElementById("gantt-last-refresh");
        if (stamp) {
          const now = new Date();
          stamp.textContent = now.toLocaleTimeString("en-NZ", {
            hour: "2-digit",
            minute: "2-digit",
            second: "2-digit",
          });
        }
      })
      .catch(err => {
        console.error("Gantt refresh failed:", err);
      })
      .finally(() => {
        // After first refresh completes, hide overlay and never show it again
        if (firstRefresh) {
          setGanttLoading(false);
          firstRefresh = false;
        }
      });
  }

  // ---------- Initial build from DOM ----------
  if (dataNodes.length) {
    const domRows = buildRowsFromDom(dataNodes);
    renderGanttFromFlights(buildFlightsFromRows(domRows));
  }

  // ---------- Hook up date form + auto-refresh ----------
  const dateForm  = document.querySelector('form[method="get"]');
  const dateInput = document.querySelector('input[name="date"]');

  // Pull fresh data once on page load (this is the ONLY time the overlay shows)
  refreshGantt();

  // Change date → AJAX refresh (no full page reload, background refresh)
  if (dateInput) {
    dateInput.addEventListener("change", function () {
      refreshGantt();
    });
  }

  // Submit "Load" button → prevent reload, just refresh Gantt
  if (dateForm) {
    dateForm.addEventListener("submit", function (ev) {
      ev.preventDefault();
      refreshGantt();
    });
  }

  // Background auto-refresh every 60s (no overlay because firstRefresh is false)
  setInterval(refreshGantt, 60_000);
});

</script>

{% endblock %}
