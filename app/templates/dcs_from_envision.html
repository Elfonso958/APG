{% extends "base.html" %}

{% block content %}
<div class="container container--wide py-3">

  <!-- Page header -->
  <div class="page-header mb-3">
    <div>
      <div class="page-kicker">DCS → Flight Plan</div>
      <h1 class="page-title">Live Gantt Overview</h1>
      <div class="page-subtitle">
        All times are NZ local (Pacific/Auckland). Click a flight bar to view details and
        <strong>submit to APG</strong>.
      </div>
    </div>

    <div class="page-meta">
      <div class="date-pill">
        <span class="dot"></span>
        <span>Loaded</span>
        <span class="date-text">
          {{ day.strftime('%a %d %b %Y') }}
        </span>
      </div>
      <div class="refresh-text">
        <small>Last refresh: <span id="gantt-last-refresh">never</span></small>
      </div>
    </div>
  </div>

  <!-- Filters row -->
  <div class="row g-2 mb-3 align-items-end">
    <!-- Date selector -->
    <div class="col-auto">
      <label class="form-label">Date</label>
      <form id="gantt-date-form" class="d-flex gap-2" method="get">
        <input type="date"
               name="date"
               class="form-control"
               value="{{ day.isoformat() }}">
        <button class="btn btn-primary" type="submit">Load</button>
      </form>
    </div>

    <div class="col"></div>

    <!-- Base filter -->
    <div class="col-auto">
      <label for="base-filter" class="form-label mb-1">Base filter</label>
      <select id="base-filter" class="form-select form-select-sm">
        <option value="">All bases</option>
        <option value="AKL">AKL (Auckland)</option>
        <option value="WLG">WLG (Wellington)</option>
        <option value="CHC">CHC (Christchurch)</option>
        <option value="PPQ">PPQ (Paraparaumu)</option>
        <option value="WHK">WHK (Whakatane)</option>
        <option value="WAG">WAG (Whanganui)</option>
        <option value="CHT">CHT (Chatham Islands)</option>
        <option value="ZQN">ZQN (Queenstown)</option>
        <option value="BHE">BHE (Blenheim)</option>
      </select>
    </div>
  </div>

  {# ---------- Hidden data for JS to build the Gantt ---------- #}
  <div id="dcs-gantt-data" class="d-none">
    {% for r in results %}
      <div
        class="gantt-flight-data"
        data-reg="{{ r.reg or 'Unknown' }}"
        data-dep="{{ r.dep }}"
        data-ades="{{ r.ades }}"
        data-std="{{ r.std_nz.isoformat() if r.std_nz }}"
        data-sta="{{ r.sta_nz.isoformat() if r.sta_nz }}"
        data-std-sched="{{ r.std_sched_nz.isoformat() if r.std_sched_nz }}"
        data-sta-sched="{{ r.sta_sched_nz.isoformat() if r.sta_sched_nz }}"
        data-dep-actual="{{ r.dep_actual_nz.isoformat() if r.dep_actual_nz }}"
        data-arr-actual="{{ r.arr_actual_nz.isoformat() if r.arr_actual_nz }}"
        data-flight="{{ r.flight_number }}"
        data-designator="{{ r.designator }}"
        data-apg-plan-id="{{ r.apg_plan_id or '' }}"
        data-block="{{ r.block_mins }}"
        data-aircraft-type="{{ r.aircraft_type }}"
        data-flight-status="{{ r.flight_status }}"
        data-adt="{{ r.adt|default(0) }}"
        data-chd="{{ r.chd|default(0) }}"
        data-inf="{{ r.inf|default(0) }}"
        data-pax-count="{{ r.pax_count|default(0) }}"
        data-bags-kg="{{ '%.1f'|format((r.bags_kg or 0)|float) }}"
        data-pax-list='{{ (r.pax_list or [])|tojson|e }}'
        data-envision-flight-id="{{ r.envision_flight_id or '' }}"
        data-delays='{{ (r.delays or [])|tojson|e }}'
      ></div>
    {% endfor %}
  </div>

  {# ---------- Visible Gantt shell (no crew card on the side) ---------- #}
  <div class="row">
    <!-- Left: Gantt -->
    <div class="col-12">
      <div class="dcs-gantt-shell card shadow-sm position-relative">
        <!-- Centered loading overlay -->
        <div id="gantt-loading" class="gantt-loading-overlay">
          <div class="gantt-loading-pill">
            <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
            Loading data…
          </div>
        </div>

        <div class="card-body p-2">
          <div class="dcs-gantt-header d-flex align-items-center mb-1">
            <div class="gantt-label-col text-muted fw-semibold">
              Aircraft
            </div>
            <div class="gantt-time-col flex-grow-1 ps-2">
              <div id="dcs-gantt-axis" class="dcs-gantt-axis"></div>
            </div>
          </div>
          <div id="dcs-gantt-rows" class="dcs-gantt-rows"></div>
        </div>
      </div>
    </div>
  </div>

  {# ---------- Diagnostics ---------- #}
  {% if diag %}
  <div class="alert alert-info mt-3">
    <div><strong>Diagnostics</strong></div>
    <div>Window used: {{ diag.window_used or 'N/A' }} <span class="text-muted">(UTC query window)</span></div>
    <div>Envision base: {{ diag.base or 'N/A' }}</div>
    <div>Token present: {{ 'Yes' if diag.has_token else 'No' }}</div>
    <div>Raw type: {{ diag.raw_type or 'N/A' }}</div>

    {% if diag.note %}
    <div class="mt-2 text-muted">{{ diag.note }}</div>
    {% endif %}

    {% if diag.raw_preview %}
    <details class="mt-2">
      <summary>JSON preview (first page or first 2 items)</summary>
      <pre class="small mb-0" style="white-space: pre-wrap">{{ diag.raw_preview }}</pre>
    </details>
    {% endif %}

    <details class="mt-3" id="apg-plan-details" style="display:none;">
      <summary>APG plan/get JSON (last pushed plan)</summary>
      <div class="small text-muted mb-1">
        Plan ID: <span id="apg-plan-id"></span>
      </div>
      <pre class="small mb-0" style="white-space: pre-wrap" id="apg-plan-json"></pre>
    </details>

    {% if diag.raw_http %}
    <details class="mt-3">
      <summary>Raw HTTP (first page)</summary>
      <div class="small">
        <div><strong>URL:</strong> {{ diag.raw_http.url }}</div>
        <div><strong>Params:</strong> {{ diag.raw_http.params }}</div>
        <div><strong>Status:</strong> {{ diag.raw_http.status }}</div>
        <div><strong>Content-Type:</strong> {{ diag.raw_http.content_type }}</div>
        {% if diag.raw_http.json_preview %}
        <details class="mt-2">
          <summary>JSON (parsed)</summary>
          <pre class="small mb-0" style="white-space: pre-wrap">{{ diag.raw_http.json_preview }}</pre>
        </details>
        {% endif %}
        {% if diag.raw_http.raw_text %}
        <details class="mt-2">
          <summary>Body (raw text)</summary>
          <pre class="small mb-0" style="white-space: pre-wrap">{{ diag.raw_http.raw_text }}</pre>
        </details>
        {% endif %}
      </div>
    </details>
    {% endif %}
  </div>
  {% endif %}
</div>

<!-- Flight Action Modal -->
<div class="modal fade" id="flightActionModal" tabindex="-1" aria-labelledby="flightActionModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-xl modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <div class="me-3">
          <h5 class="modal-title mb-0" id="flightActionModalLabel">Flight Details</h5>
          <div id="flight-warnings" class="small mt-1"></div>
        </div>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>

      <div class="modal-body">
        <div class="flight-details-grid">
          <!-- Q1: Flight / Route / Aircraft + Crew (RIGHT SIDE) -->
          <div class="detail-card">
            <!-- Top row: aligned headings -->
            <div class="d-flex justify-content-between">
              <h6 class="detail-title mb-0">Flight</h6>
              <h6 class="detail-title mb-0">Crew (Envision)</h6>
            </div>

            <!-- Second row: content -->
            <div class="d-flex flex-column flex-md-row gap-3 mt-1">
              <!-- Left: Flight information -->
              <div class="flex-grow-1">
                <p class="mb-1 fw-semibold">
                  <span id="modal-flight-code"></span>
                </p>
                <p class="mb-1 small text-muted">
                  Route:
                  <span id="modal-route"></span>
                </p>
                <p class="mb-0 small text-muted">
                  Aircraft:
                  <span id="modal-aircraft"></span>
                </p>
              </div>

              <!-- Right: Crew (Envision) -->
              <div class="flex-grow-1">
                <div id="modal-crew" class="small"></div>
              </div>
            </div>
          </div>


          <!-- Q2: Times / Status -->
          <div class="detail-card detail-card-times">
            <h6 class="detail-title">Times</h6>

            <div class="time-row">
              <span class="time-label">STD / STA</span>
              <span class="time-value" id="modal-std-sta"></span>
            </div>
            <div class="time-row">
              <span class="time-label">ETD / ETA</span>
              <span class="time-value" id="modal-etd-eta"></span>
            </div>
            <div class="time-row">
              <span class="time-label">ATD / ATA</span>
              <span class="time-value" id="modal-atd-ata">— / —</span>
            </div>
            <div class="time-row mt-1">
              <span class="time-label">Status</span>
              <span class="time-value" id="modal-status"></span>
            </div>
          </div>

          <!-- Q3: Delays -->
          <div class="detail-card detail-card-delays">
            <h6 class="detail-title">Delays</h6>
            <div id="modal-delays" class="small text-muted">
              <!-- filled by JS -->
            </div>
          </div>

          <!-- Q4: Passengers & Baggage -->
          <div class="detail-card detail-card-pax">
            <h6 class="detail-title">Passengers</h6>

            <div id="modal-pax-breakdown" class="pax-breakdown small mb-2">
              <!-- filled by JS -->
            </div>

            <div class="small text-muted" id="modal-pax-types"></div>

            <hr class="my-2">

            <h6 class="detail-title mb-1">Baggage</h6>
            <p class="mb-0 small">
              <span id="modal-bags"></span> kg
            </p>
          </div>
        </div>

        <hr class="my-3">

        <div class="d-flex flex-wrap gap-2">
          <button id="btn-view-pax" type="button" class="btn btn-outline-secondary btn-sm">
            Passenger list
          </button>
          <button id="btn-seatmap" type="button" class="btn btn-outline-secondary btn-sm">
            Seat map
          </button>
        </div>
      </div>

      <div class="modal-footer">
        <button class="btn btn-sm btn-outline-secondary" id="btn-preview-manifest">
          Preview Manifest
        </button>
        <button id="btn-reset-apg" type="button" class="btn btn-success">Reset Flight</button>
        <button id="btn-send-apg" type="button" class="btn btn-success">Submit to APG</button>
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<!-- Passenger List Modal -->
<div class="modal fade" id="paxListModal" tabindex="-1"
     aria-labelledby="paxListModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="paxListModalLabel">Passenger list</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"
                aria-label="Close"></button>
      </div>

      <div class="modal-body">
        <div class="table-responsive mb-0">
          <table id="pax-list-table" class="table table-sm align-middle mb-0">
            <thead>
              <tr>
                <th>Seat</th>
                <th>Name</th>
                <th>DOB</th>
                <th>Age</th>
                <th>PNR</th>
                <th>Status</th>
                <th>SSR(s)</th>
              </tr>
            </thead>
            <tbody id="pax-list-body">
              <!-- filled by JS -->
            </tbody>
          </table>
        </div>
      </div>

      <div class="modal-footer">
        <button type="button" class="btn btn-secondary btn-sm"
                data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<!-- Seatmap Modal -->
<div class="modal fade" id="seatmapModal" tabindex="-1" aria-labelledby="seatmapModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="seatmapModalLabel">Seat map</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="row">
          <div class="col-md-8">
            <div id="seatmap-container" class="seatmap-grid"></div>
          </div>
          <div class="col-md-4">
            <div id="seatmap-info" class="small text-muted">
              Seatmap not available for this aircraft type.<br>
              Click a seat to see passenger details.
            </div>
          </div>
        </div>

        <div id="seatmap-legend" class="small mt-2">
          <span class="legend-item">
            <span class="seat seat-adult"></span> Adult
          </span>
          <span class="legend-item">
            <span class="seat seat-child"></span> Child
          </span>
          <span class="legend-item">
            <span class="seat seat-child seat-umnr"></span> UMNR
          </span>
          <span class="legend-item">
            <span class="seat seat-infant"></span> Infant in Lap
          </span>
          <span class="legend-item">
            <span class="seat-icon seat-icon-special">!</span> Special SSR
          </span>
          <span class="legend-item">
            <span class="seat-icon seat-icon-wheelchair">♿</span> Wheelchair SSR
          </span>
        </div>
      </div>
      <div class="modal-footer">
        <small class="text-muted me-auto">Layout is indicative only.</small>
        <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<!-- Times / Delay Modal -->
<div class="modal fade" id="timeModal" tabindex="-1" aria-labelledby="timeModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="timeModalLabel">Times</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div id="time-modal-core"></div>

        <div id="delay-section" class="mt-3 pt-2 border-top d-none">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <strong>Delay Codes</strong>
            <button id="btn-add-delay" type="button" class="btn btn-outline-secondary btn-sm">Add code</button>
          </div>
          <div class="table-responsive">
            <table class="table table-sm mb-2">
              <thead>
                <tr>
                  <th>Code</th>
                  <th class="text-end">Minutes</th>
                  <th>Reason</th>
                  <th>Remark</th>
                  <th></th>
                </tr>
              </thead>
              <tbody id="delay-rows"></tbody>
            </table>
          </div>
          <div class="small">
            Required delay: <span id="delay-required">0</span> min<br>
            Allocated: <span id="delay-allocated">0</span> min
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <small class="text-muted me-auto">
          Times are local and not yet persisted.
        </small>
        <button type="button" class="btn btn-primary btn-sm" id="btn-save-times">
          Save times
        </button>
        <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">
          Close
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Right-click context menu -->
<div id="flightContextMenu" class="dropdown-menu" style="position:absolute; display:none; z-index:1060;">
  <button class="dropdown-item" type="button" id="ctx-departure">Departure Times</button>
  <button class="dropdown-item" type="button" id="ctx-arrival">Arrival Times</button>
</div>

<div id="dcs-gantt-root"
     data-gantt-url="{{ url_for('ui.api_dcs_gantt_data') }}"
     data-apg-push-url="{{ url_for('api.api_dcs_push_to_apg') }}"
     data-apg-reset-url="{{ url_for('api.api_apg_reset_passengers') }}"
     data-save-times-url="{{ url_for('api.api_dcs_save_times') }}"
     data-env-times-url="{{ url_for('ui.api_envision_flight_times') }}"
     data-apg-plan-url-template="{{ url_for('api.api_apg_plan_get', plan_id=0) }}"
     data-env-crew-url="{{ url_for('api.api_envision_flight_crew') }}">
</div>

{% endblock %}

{% block head_extra %}
  <link rel="stylesheet" href="{{ url_for('static', filename='css/gantt.css') }}">
{% endblock %}

{% block scripts %}
  {{ super() }}
  <script src="{{ url_for('static', filename='js/flight_schedule.js') }}"></script>
{% endblock %}
